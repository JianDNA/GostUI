# 智能更新指南

## 🚀 智能更新脚本说明

`smart-update.sh` 是专为解决Git冲突和简化更新流程而设计的傻瓜式更新脚本。

## ✨ 主要特点

### 🔧 完全避免Git冲突
- **问题**: 每次部署后，`backend/public`目录会有新文件，直接`git pull`会产生冲突
- **解决**: 使用临时目录克隆最新代码，完全避免在当前目录操作Git

### 💾 完整的数据保护
- **自动备份**: 数据库、配置文件、GOST配置、日志文件
- **智能恢复**: 更新完成后自动恢复所有用户数据
- **安全第一**: 即使更新失败也不会丢失任何数据

### ⚙️ 自动配置修复
- **检测缺失配置**: 自动检查SystemConfigs表中的必需配置
- **自动添加配置**: 修复`disabledProtocols`、`allowedProtocols`等缺失配置
- **解决接口报错**: 修复404和403接口错误

### 🎯 智能前端处理
- **检测预构建文件**: 自动判断是否使用预构建文件
- **自动构建**: 如果预构建文件不完整，自动重新构建
- **完整验证**: 确保前端文件完整性

## 📋 使用方法

### 基本用法
```bash
# 进入项目目录
cd ~/GostUI

# 给脚本执行权限
chmod +x smart-update.sh

# 运行智能更新
./smart-update.sh
```

### 完整流程
```bash
# 1. 确认更新
🤔 确认开始智能更新？(y/N): y

# 2. 智能更新源码
📥 步骤1: 智能更新源码...
📁 临时目录: /tmp/gost-smart-update-20250616_164555
🔄 获取最新代码...
✅ 最新代码获取完成

# 3. 备份用户数据
💾 步骤2: 备份用户数据...
✅ 已备份数据库
✅ 已备份环境配置
✅ 已备份GOST配置

# 4. 停止服务
🛑 步骤3: 停止服务...
✅ 服务已停止

# 5. 更新部署文件
🔄 步骤4: 更新部署文件...
✅ 代码文件更新完成

# 6. 处理前端文件
📦 步骤5: 处理前端文件...
✅ 检测到完整的预构建文件
✅ 前端文件部署完成（使用预构建）

# 7. 恢复用户数据
🔄 步骤6: 恢复用户数据...
✅ 数据库已恢复
✅ 配置文件已恢复

# 8. 修复系统配置
⚙️ 步骤7: 检查并修复系统配置...
✅ 系统配置完整，无需修复

# 9. 启动服务
🚀 步骤8: 启动服务...
✅ 服务启动成功！
✅ 前端页面访问正常

# 10. 清理临时文件
🧹 步骤9: 清理临时文件...
✅ 临时文件清理完成

# 11. 完成
🎉 智能更新完成！
```

## 🔧 解决的问题

### 1. Git冲突问题
**问题**: 
```bash
error: Your local changes to the following files would be overwritten by merge:
    backend/public/assets/index-xxx.js
    backend/public/index.html
```

**解决**: 使用临时目录克隆，完全避免Git操作冲突

### 2. 系统配置缺失
**问题**:
```bash
GET /api/system-config/disabledProtocols
# 返回: {"message":"配置不存在"}
```

**解决**: 自动检测并添加缺失的SystemConfigs配置

### 3. 生产环境安全限制
**问题**:
```bash
GET /api/gost-config/compare
# 返回: {"error":"PRODUCTION_SAFETY_BLOCK"}
```

**解决**: 自动更新PM2配置，添加`DISABLE_PRODUCTION_SAFETY=true`

### 4. 前端文件不一致
**问题**: 新旧前端文件混合，导致加载错误

**解决**: 完全删除旧文件，重新部署新文件

## 📊 与传统更新的对比

| 特性 | 智能更新 | 传统更新 |
|------|----------|----------|
| Git冲突处理 | ✅ 自动避免 | ❌ 需要手动解决 |
| 数据备份 | ✅ 自动备份恢复 | ⚠️ 部分备份 |
| 配置修复 | ✅ 自动检测修复 | ❌ 需要手动修复 |
| 前端处理 | ✅ 智能检测构建 | ⚠️ 基本处理 |
| 错误处理 | ✅ 完整错误处理 | ⚠️ 基本错误处理 |
| 用户操作 | ✅ 一键完成 | ❌ 多步操作 |

## 🛠️ 故障排除

### 如果更新失败

1. **检查备份目录**
   ```bash
   ls /tmp/gost-deploy-backup-*
   ```

2. **手动恢复数据**
   ```bash
   # 恢复数据库
   cp /tmp/gost-deploy-backup-*/database.sqlite /root/gost-management/backend/database/
   
   # 恢复配置
   cp /tmp/gost-deploy-backup-*/.env /root/gost-management/backend/
   
   # 重启服务
   cd /root/gost-management/backend
   pm2 restart gost-management
   ```

3. **查看详细日志**
   ```bash
   pm2 logs gost-management
   ```

### 常见问题

**Q: 更新过程中断电了怎么办？**
A: 所有用户数据都有备份，可以从`/tmp/gost-deploy-backup-*`目录恢复

**Q: 更新后服务启动失败？**
A: 检查PM2日志，通常是依赖问题，重新运行脚本即可

**Q: 前端页面显示异常？**
A: 清除浏览器缓存，或者重新运行更新脚本

## 💡 最佳实践

1. **定期更新**: 建议每周运行一次智能更新
2. **备份重要数据**: 虽然脚本会自动备份，但建议定期手动备份重要数据
3. **监控服务状态**: 更新后检查`pm2 status`确保服务正常
4. **测试功能**: 更新后测试主要功能是否正常

## 📞 获取帮助

如果遇到问题：
1. 查看脚本输出的详细日志
2. 检查`/tmp/gost-deploy-backup-*`备份目录
3. 运行`pm2 logs gost-management`查看服务日志
4. 提交GitHub Issues获取社区帮助

---

**💡 提示**: 智能更新脚本是推荐的更新方式，它能够处理99%的更新场景，让用户无需关心技术细节。
