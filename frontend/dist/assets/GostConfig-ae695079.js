import{ax as a,ay as s,c as e,r as t,X as n,k as l,S as o,z as c,A as i,P as r,H as d,G as u,K as g,ag as p,y as v,L as y,M as m,C as f,O as h,a4 as b}from"./vue-9e38bd25.js";import{E as _,j as w,k as C}from"./element-plus-a98c71bf.js";import{a as S}from"./api-c059019c.js";import{_ as k}from"./index-1003864c.js";import"./utils-c29d00eb.js";const E={class:"gost-config"},j={class:"page-header"},L={class:"header-actions"},A={class:"stat-content"},x={class:"stat-number"},T={class:"stat-content"},V={class:"stat-number"},M={class:"stat-content"},O={class:"stat-number"},z={class:"stat-content"},G={class:"card-header"},H={class:"comparison-info"},I={style:{"margin-top":"8px"}},P={class:"config-content"},R={class:"config-header"},D={class:"config-json"},F={class:"config-content"},J={class:"config-header"},N={class:"config-json"},q={class:"card-header"},K={class:"log-content"},U={key:0,class:"no-logs"},X={key:1},B={class:"log-time"},Q={class:"log-message"};const W=k({name:"GostConfig",setup(){const c=a(),i=s();if(!e((()=>c.getters["user/isAdmin"])).value)return _.error("此功能仅限管理员使用"),i.push("/dashboard"),{};const r=t(!1),d=n({serviceCount:0,portCount:0,userCount:0,protocols:[]}),u=t(!1),g=t(null),p=t("generated"),v=t([]),y=t(null),m=(a,s="info")=>{v.value.unshift({time:new Date,message:a,type:s}),v.value.length>50&&(v.value=v.value.slice(0,50))},f=async()=>{var a,s;try{const a=await S.get("/gost-config/stats");Object.assign(d,a.data.data);try{const a=await S.get("/gost-config/sync-status");u.value=a.data.data.autoSyncRunning||!1}catch(e){}}catch(e){m("加载统计信息失败: "+((null==(s=null==(a=e.response)?void 0:a.data)?void 0:s.message)||e.message),"error")}},h=async()=>{var a,s,e;try{const a=await S.get("/gost-config/compare");g.value=a.data.data}catch(t){401===(null==(a=t.response)?void 0:a.status)?(g.value={isChanged:!1,reason:"auth_required",message:"需要管理员权限查看配置比较"},m("配置比较需要管理员权限","warning")):(g.value={isChanged:!1,reason:"comparison_failed",message:"配置比较服务暂时不可用"},_.error("加载配置对比失败"),m("配置比较加载失败: "+((null==(e=null==(s=t.response)?void 0:s.data)?void 0:e.message)||t.message),"error"))}},b=async(a=!1)=>{var s,e,t,n;r.value=!0;try{const s=await S.post("/gost-config/sync",{force:a}),e=s.data.data;e.updated?(_.success("配置已更新并同步"),m("手动同步成功，配置已更新","success")):e.skipped?(_.warning(s.data.message||"同步已跳过"),m(s.data.message||"同步已跳过","warning")):(_.info("配置无变化"),m("手动同步完成，配置无变化","info")),await f(),await h()}catch(l){_.error("手动同步失败: "+((null==(e=null==(s=l.response)?void 0:s.data)?void 0:e.message)||l.message)),m("手动同步失败: "+((null==(n=null==(t=l.response)?void 0:t.data)?void 0:n.message)||l.message),"error")}finally{r.value=!1}},k=async()=>{try{await S.post("/gost-config/auto-sync/start"),_.success("自动同步已启动"),m("自动同步已启动","success"),u.value=!0,await f()}catch(a){_.error("启动自动同步失败"),m("启动自动同步失败","error")}},E=async()=>{try{await S.post("/gost-config/auto-sync/stop"),_.success("自动同步已停止"),m("自动同步已停止","warning"),u.value=!1,await f()}catch(a){_.error("停止自动同步失败"),m("停止自动同步失败","error")}};return l((async()=>{m("页面已加载"),await f(),await h(),y.value=setInterval((async()=>{await f(),g.value&&await h()}),3e4)})),o((()=>{y.value&&(clearInterval(y.value),y.value=null)})),{syncing:r,stats:d,comparison:g,activeTab:p,syncLogs:v,addLog:m,formatTime:a=>a.toLocaleString(),clearLogs:()=>{v.value=[],m("日志已清空")},loadStats:f,loadComparison:h,syncConfig:b,handleManualSync:b,handleForceSync:async()=>{await b(!0)},handleStartAutoSync:k,handleStopAutoSync:E,toggleAutoSync:async()=>{u.value?await E():await k()},autoSyncEnabled:u,Check:w,Close:C}}},[["render",function(a,s,e,t,n,l){const o=p("el-button"),_=p("el-card"),w=p("el-col"),C=p("el-row"),S=p("el-alert"),k=p("el-tab-pane"),W=p("el-tabs");return v(),c("div",E,[i("div",j,[s[3]||(s[3]=i("h2",null,"Gost 配置管理",-1)),i("div",L,[r(o,{type:"primary",onClick:t.handleManualSync,loading:t.syncing,icon:"Refresh"},{default:d((()=>s[2]||(s[2]=[y(" 手动同步 ")]))),_:1,__:[2]},8,["onClick","loading"]),r(o,{type:t.autoSyncEnabled?"warning":"success",onClick:t.toggleAutoSync,loading:t.syncing,icon:t.autoSyncEnabled?"VideoPause":"VideoPlay"},{default:d((()=>[y(m(t.autoSyncEnabled?"停止自动同步":"启动自动同步"),1)])),_:1},8,["type","onClick","loading","icon"])])]),r(C,{gutter:20,class:"stats-row"},{default:d((()=>[r(w,{span:6},{default:d((()=>[r(_,{class:"stat-card"},{default:d((()=>[i("div",A,[i("div",x,m(t.stats.serviceCount||0),1),s[4]||(s[4]=i("div",{class:"stat-label"},"服务数量",-1)),s[5]||(s[5]=i("div",{class:"stat-description"},"当前运行的服务",-1))])])),_:1})])),_:1}),r(w,{span:6},{default:d((()=>[r(_,{class:"stat-card"},{default:d((()=>[i("div",T,[i("div",V,m(t.stats.portCount||0),1),s[6]||(s[6]=i("div",{class:"stat-label"},"端口数量",-1)),s[7]||(s[7]=i("div",{class:"stat-description"},"已配置的端口",-1))])])),_:1})])),_:1}),r(w,{span:6},{default:d((()=>[r(_,{class:"stat-card"},{default:d((()=>[i("div",M,[i("div",O,m(t.stats.userCount||0),1),s[8]||(s[8]=i("div",{class:"stat-label"},"用户数量",-1)),s[9]||(s[9]=i("div",{class:"stat-description"},"系统用户总数",-1))])])),_:1})])),_:1}),r(w,{span:6},{default:d((()=>[r(_,{class:"stat-card clickable-card",onClick:t.toggleAutoSync},{default:d((()=>[i("div",z,[i("div",{class:f(["stat-number",{enabled:t.autoSyncEnabled,disabled:!t.autoSyncEnabled}])},m(t.autoSyncEnabled?"开启":"停止"),3),s[10]||(s[10]=i("div",{class:"stat-label"},"自动同步",-1)),i("div",{class:f(["stat-description",{enabled:t.autoSyncEnabled,disabled:!t.autoSyncEnabled}])},m(t.autoSyncEnabled?"配置自动同步中":"点击启用自动同步"),3)])])),_:1},8,["onClick"])])),_:1})])),_:1}),t.comparison?(v(),u(_,{key:0,class:"config-compare"},{header:d((()=>[i("div",G,[s[12]||(s[12]=i("span",null,"配置对比",-1)),r(o,{type:"text",onClick:t.loadComparison,icon:"Refresh"},{default:d((()=>s[11]||(s[11]=[y("刷新")]))),_:1,__:[11]},8,["onClick"])])])),default:d((()=>[i("div",H,[t.comparison.isChanged?(v(),u(S,{key:0,title:"配置已变更",type:"warning","show-icon":"",closable:!1},{default:d((()=>[s[15]||(s[15]=i("div",null,"检测到配置变化，建议手动同步或等待自动同步",-1)),i("div",I,[r(o,{type:"primary",size:"small",onClick:s[0]||(s[0]=a=>t.handleManualSync(!1)),loading:t.syncing},{default:d((()=>s[13]||(s[13]=[y(" 立即同步 ")]))),_:1,__:[13]},8,["loading"]),r(o,{type:"warning",size:"small",onClick:t.handleForceSync,loading:t.syncing},{default:d((()=>s[14]||(s[14]=[y(" 强制同步 ")]))),_:1,__:[14]},8,["onClick","loading"])])])),_:1})):(v(),u(S,{key:1,title:"配置已同步",type:"success",description:"当前配置与生成配置一致","show-icon":"",closable:!1}))]),r(W,{modelValue:t.activeTab,"onUpdate:modelValue":s[1]||(s[1]=a=>t.activeTab=a),class:"config-tabs"},{default:d((()=>[r(k,{label:"生成的配置",name:"generated"},{default:d((()=>[i("div",P,[i("div",R,[i("span",null,"服务数量: "+m(t.comparison.generated.services.length),1),i("span",null,"哈希值: "+m(t.comparison.generatedHash.substring(0,16))+"...",1)]),i("pre",D,m(JSON.stringify(t.comparison.generated,null,2)),1)])])),_:1}),r(k,{label:"当前配置",name:"current"},{default:d((()=>[i("div",F,[i("div",J,[i("span",null,"服务数量: "+m(t.comparison.current.services.length),1),i("span",null,"哈希值: "+m(t.comparison.currentHash.substring(0,16))+"...",1)]),i("pre",N,m(JSON.stringify(t.comparison.current,null,2)),1)])])),_:1})])),_:1},8,["modelValue"])])),_:1})):g("",!0),r(_,{class:"sync-log"},{header:d((()=>[i("div",q,[s[17]||(s[17]=i("span",null,"同步日志",-1)),r(o,{type:"text",onClick:t.clearLogs,icon:"Delete"},{default:d((()=>s[16]||(s[16]=[y("清空日志")]))),_:1,__:[16]},8,["onClick"])])])),default:d((()=>[i("div",K,[0===t.syncLogs.length?(v(),c("div",U," 暂无同步日志 ")):(v(),c("div",X,[(v(!0),c(h,null,b(t.syncLogs,((a,s)=>(v(),c("div",{key:s,class:f(["log-item",a.type])},[i("div",B,m(t.formatTime(a.time)),1),i("div",Q,m(a.message),1)],2)))),128))]))])])),_:1})])}],["__scopeId","data-v-d023b86c"]]);export{W as default};
