# Gost 配置自动同步系统

## 概述

本系统实现了 Gost 配置的自动生成和同步功能，根据数据库中有效用户的转发规则自动生成 Gost 配置文件，并保持配置与数据库状态的实时同步。

## 功能特性

### 1. 自动配置生成
- 根据数据库中有效用户（未过期且启用的用户）的转发规则生成 Gost 配置
- 支持 TCP、UDP、TLS 协议的端口转发
- 按协议和端口排序，确保配置的一致性和可比较性
- 自动验证用户端口权限，只包含用户允许范围内的端口

### 2. 定时同步机制
- 每 25 秒自动检查数据库配置与当前 Gost 配置的差异
- 使用 SHA256 哈希值进行高效的配置比较
- 只有在配置发生变化时才更新 Gost 服务
- 自动重启 Gost 服务以应用新配置

### 3. 实时触发同步
- 用户创建、更新、删除转发规则时立即触发配置同步
- 用户端口范围变更时自动同步配置
- 用户删除时自动清理相关配置

### 4. 管理界面
- 提供 Web 界面查看配置状态和统计信息
- 支持手动触发配置同步
- 可以启动/停止自动同步功能
- 实时显示配置对比和同步日志

## 系统架构

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   数据库变更    │───▶│  配置同步服务    │───▶│   Gost 服务     │
│  (用户/规则)    │    │ GostConfigService│    │   (重启应用)    │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                       │                       │
         │              ┌────────▼────────┐              │
         │              │   定时器 (25s)   │              │
         │              │   配置比较       │              │
         │              └─────────────────┘              │
         │                       │                       │
         └───────────────────────▼───────────────────────┘
                        配置文件持久化
                    (gost-config.json)
```

## 核心组件

### 1. GostConfigService (后端服务)
- **位置**: `backend/services/gostConfigService.js`
- **功能**: 
  - 配置生成和比较
  - 定时同步管理
  - 文件操作和服务控制

### 2. GostConfig API (后端路由)
- **位置**: `backend/routes/gostConfig.js`
- **端点**:
  - `GET /api/gost-config/generate` - 生成配置
  - `GET /api/gost-config/current` - 获取当前配置
  - `POST /api/gost-config/sync` - 手动同步
  - `GET /api/gost-config/stats` - 获取统计信息
  - `POST /api/gost-config/auto-sync/start` - 启动自动同步
  - `POST /api/gost-config/auto-sync/stop` - 停止自动同步

### 3. GostConfig 管理页面 (前端)
- **位置**: `frontend/src/views/GostConfig.vue`
- **功能**:
  - 配置状态监控
  - 手动同步操作
  - 配置对比显示
  - 同步日志查看

## 配置格式

生成的 Gost 配置遵循标准的 Gost v3 配置格式：

```json
{
  "services": [
    {
      "name": "forward-tcp-8080",
      "addr": ":8080",
      "handler": {
        "type": "tcp",
        "chain": "chain-tcp-8080"
      },
      "listener": {
        "type": "tcp"
      },
      "metadata": {
        "userId": 1,
        "username": "user1",
        "ruleId": 1,
        "ruleName": "Web Server",
        "description": "转发到内网Web服务器"
      }
    }
  ],
  "chains": [
    {
      "name": "chain-tcp-8080",
      "hops": [
        {
          "name": "hop-0",
          "nodes": [
            {
              "addr": "192.168.1.100:80",
              "connector": {
                "type": "tcp"
              }
            }
          ]
        }
      ]
    }
  ]
}
```

## 使用方法

### 1. 启动系统
系统会在应用启动时自动启动配置同步服务：

```bash
cd backend
npm start
```

### 2. 管理配置同步
访问管理界面：`http://localhost:8080/gost-config`（需要管理员权限）

### 3. 测试配置服务
运行测试脚本验证功能：

```bash
cd backend
node test-gost-config.js
```

## 配置参数

### 同步间隔
默认每 25 秒检查一次配置变化，可在 `GostConfigService` 中修改：

```javascript
this.syncInterval = 25000; // 毫秒
```

### 配置文件路径
默认配置文件路径：`backend/config/gost-config.json`

## 安全考虑

1. **权限控制**: 只有管理员可以访问配置管理界面
2. **端口验证**: 严格验证用户端口权限，防止越权访问
3. **配置备份**: 配置更新前自动备份原配置
4. **错误处理**: 完善的错误处理和日志记录

## 故障排除

### 1. 配置同步失败
- 检查数据库连接状态
- 查看应用日志中的错误信息
- 验证 Gost 服务是否正常运行

### 2. 配置不生效
- 确认 Gost 服务已重启
- 检查配置文件格式是否正确
- 验证端口是否被其他进程占用

### 3. 自动同步停止
- 检查定时器是否正常运行
- 查看系统资源使用情况
- 重启应用恢复自动同步

## 扩展功能

### 1. 配置模板
可以扩展支持不同的配置模板，适应不同的使用场景。

### 2. 配置验证
增加更严格的配置验证，确保生成的配置符合 Gost 规范。

### 3. 性能优化
对于大量规则的场景，可以优化配置生成和比较的性能。

### 4. 监控告警
集成监控系统，在配置同步失败时发送告警通知。

## 版本历史

- **v1.0.0**: 基础配置生成和同步功能
- **v1.1.0**: 添加 Web 管理界面
- **v1.2.0**: 优化配置比较算法，提升性能
