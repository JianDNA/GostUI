import{ax as e,ay as a,c as t,r as l,X as s,k as n,z as o,A as i,P as c,H as u,G as d,K as r,ag as m,y as p,L as g,M as h,O as f,a4 as v}from"./vue-9e38bd25.js";import{a as y}from"./api-c059019c.js";import{_ as C}from"./index-1003864c.js";import{E as T,f as S}from"./element-plus-a98c71bf.js";import"./utils-c29d00eb.js";const _={class:"performance-config"},b={class:"card-header"},P={class:"mode-content"},w={class:"mode-description"},M={key:0,class:"simple-mode-info"},V={class:"manual-sync-section"},k={key:1,class:"auto-mode-info"},x={class:"mode-switch"},I={class:"preset-buttons"},L={class:"preset-descriptions"},O={class:"card-header"},z={class:"protocol-content"},U={class:"protocol-checkboxes"},H={class:"card-header"},G={class:"config-section"},B={class:"config-item"},A={class:"param-help"},F={class:"config-item"},j={class:"param-help"},$={class:"config-item"},K={class:"config-item"},N={class:"param-help"},R={class:"config-section"},D={class:"config-item"},E={class:"param-help"},X={class:"config-item"},q={class:"param-help"},J={class:"config-item"},Q={class:"config-section"},W={class:"config-item"},Y={class:"param-help"},Z={class:"config-item"},ee={class:"param-help"},ae={class:"card-header"},te={class:"status-content"},le={class:"status-item"},se={class:"status-item"},ne={class:"status-item"},oe={key:0,class:"last-updated"};const ie=C({name:"PerformanceConfig",setup(){const o=e(),i=a();if(!t((()=>o.getters["user/isAdmin"])).value)return T.error("此功能仅限管理员使用"),i.push("/dashboard"),{};const c=l(!1),u=l(!1),d=l(!1),r=l(!1),m=l(!1),p=l(""),g=l(!1),h=l("plugins"),f=l([]),v=l({}),C=s({systemMode:{isSimpleMode:!1},gostPlugins:{authTimeout:5,observerTimeout:10,limiterTimeout:5},cacheConfig:{authCacheTimeout:6e5,limiterCacheTimeout:3e5,multiInstanceCacheTTL:12e4},syncConfig:{autoSyncInterval:3e5,healthCheckInterval:12e4},observerPeriod:120}),_=l({}),b=l({}),P=l({}),w=t({get:()=>C.systemMode.isSimpleMode,set:e=>{C.systemMode.isSimpleMode=e}}),M=t((()=>w.value?"simple":"auto")),V=t({get:()=>Math.round(C.cacheConfig.authCacheTimeout/6e4),set:e=>{C.cacheConfig.authCacheTimeout=6e4*e}}),k=t({get:()=>C.cacheConfig.limiterCacheTimeout/6e4,set:e=>{C.cacheConfig.limiterCacheTimeout=6e4*e}}),x=t({get:()=>C.cacheConfig.multiInstanceCacheTTL/6e4,set:e=>{C.cacheConfig.multiInstanceCacheTTL=6e4*e}}),I=t({get:()=>C.syncConfig.autoSyncInterval/6e4,set:e=>{C.syncConfig.autoSyncInterval=6e4*e}}),L=t({get:()=>C.syncConfig.healthCheckInterval/6e4,set:e=>{C.syncConfig.healthCheckInterval=6e4*e}}),O=t({get:()=>{var e;return(null==(e=C.gostPlugins)?void 0:e.observerPeriod)||120},set:e=>{C.gostPlugins||(C.gostPlugins={}),C.gostPlugins.observerPeriod=e}}),z=async()=>{try{c.value=!0;const e=await y.get("/performance-config");e.data.success&&(v.value=e.data.data.config,_.value=e.data.data.modeStatus,Object.assign(C,e.data.data.config)),await U()}catch(e){T.error("加载配置失败: "+e.message)}finally{c.value=!1}},U=async()=>{try{const e=await y.get("/system-config/disabledProtocols");e.data.success&&e.data.data&&(f.value=e.data.data.value||[])}catch(e){f.value=[]}},H=async()=>{try{d.value=!0;const e=await y.get("/performance-config/status");e.data.success&&(_.value=e.data.data)}catch(e){T.error("刷新状态失败: "+e.message)}finally{d.value=!1}};return n((async()=>{await z(),await(async()=>{try{const e=await y.get("/performance-config/help");e.data.success&&(b.value=e.data.data.presets||{},P.value=e.data.data.parameterHelp||{})}catch(e){}})(),await H()})),{loading:c,saveLoading:u,statusLoading:d,modeSwitchLoading:r,manualSyncLoading:m,presetLoading:p,protocolSaveLoading:g,activeTab:h,config:v,configForm:C,systemStatus:_,presets:b,parameterHelp:P,isSimpleMode:w,currentMode:M,authCacheMinutes:V,limiterCacheMinutes:k,multiInstanceCacheMinutes:x,autoSyncMinutes:I,healthCheckMinutes:L,observerPeriodSeconds:O,disabledProtocols:f,loadConfig:z,loadProtocolConfig:U,refreshStatus:H,saveConfig:async()=>{try{u.value=!0;const e=await y.put("/performance-config",{...C,description:"管理员更新性能配置"});e.data.success&&(T.success("配置保存成功"),await z(),e.data.data.modeChanged&&T.info("系统模式已切换到"+("simple"===e.data.data.newMode?"单机模式":"自动模式")))}catch(e){T.error("保存配置失败: "+e.message)}finally{u.value=!1}},saveProtocolConfig:async()=>{try{g.value=!0;(await y.put("/system-config/disabledProtocols",{value:f.value,description:"管理员更新禁用协议配置",category:"security"})).data.success&&(T.success("协议屏蔽配置保存成功"),await U())}catch(e){T.error("保存协议屏蔽配置失败: "+e.message)}finally{g.value=!1}},handleModeSwitch:async e=>{try{r.value=!0;await S.confirm(`确定要切换到${e?"单机模式":"自动模式"}吗？\n\n${e?"单机模式将禁用所有自动化功能，需要手动同步配置":"自动模式将启用所有自动化功能，配置变更将自动同步"}`,"确认模式切换",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const a=await y.post("/performance-config/switch-mode",{isSimpleMode:e,description:"管理员切换到"+(e?"单机模式":"自动模式")});a.data.success&&(T.success(a.data.message),await z(),await H())}catch(a){"cancel"!==a&&T.error("切换模式失败: "+a.message),C.systemMode.isSimpleMode=!e}finally{r.value=!1}},handleManualSync:async()=>{try{m.value=!0;await S.confirm("确定要手动同步GOST配置吗？\n\n这将重新生成配置文件并重启GOST服务，可能会短暂中断现有连接。","确认手动同步",{confirmButtonText:"确定同步",cancelButtonText:"取消",type:"warning"});(await y.post("/performance-config/manual-sync")).data.success&&(T.success("GOST配置同步成功"),await H())}catch(e){"cancel"!==e&&T.error("手动同步失败: "+e.message)}finally{m.value=!1}},applyPreset:async e=>{var a,t;try{if(p.value=e,w.value)return void T.error("性能预设只能在自动模式下应用，请先切换到自动模式");const a=b.value[e];await S.confirm(`确定要应用"${a.name}"预设配置吗？\n\n${a.description}\n\n这将覆盖当前的详细配置参数。`,"确认应用预设",{confirmButtonText:"确定应用",cancelButtonText:"取消",type:"info"});(await y.post("/performance-config/apply-preset",{presetName:e,description:`应用预设配置: ${a.name}`})).data.success&&(T.success(`预设配置"${a.name}"应用成功`),await z(),await H())}catch(l){if("cancel"!==l){const e=(null==(t=null==(a=l.response)?void 0:a.data)?void 0:t.message)||l.message||"应用预设失败";T.error(e)}}finally{p.value=""}},getPresetButtonType:e=>"highPerformance"===e?"danger":"balanced"===e?"primary":"highAvailability"===e?"success":"default",getParamHelp:(e,a)=>{var t,l;return(null==(l=null==(t=P.value[e])?void 0:t[a])?void 0:l.description)||""},formatTime:e=>e?new Date(e).toLocaleString("zh-CN"):"未知",updateAuthCacheTimeout:e=>{C.cacheConfig.authCacheTimeout=6e4*e},updateLimiterCacheTimeout:e=>{C.cacheConfig.limiterCacheTimeout=6e4*e},updateMultiInstanceCacheTTL:e=>{C.cacheConfig.multiInstanceCacheTTL=6e4*e},updateAutoSyncInterval:e=>{C.syncConfig.autoSyncInterval=6e4*e},updateHealthCheckInterval:e=>{C.syncConfig.healthCheckInterval=6e4*e},updateObserverPeriod:()=>{}}}},[["render",function(e,a,t,l,s,n){const y=m("el-tag"),C=m("el-alert"),T=m("el-button"),S=m("el-switch"),ie=m("el-card"),ce=m("el-checkbox"),ue=m("el-checkbox-group"),de=m("el-input-number"),re=m("el-col"),me=m("el-row"),pe=m("el-tab-pane"),ge=m("el-tabs");return p(),o("div",_,[a[46]||(a[46]=i("div",{class:"page-header"},[i("h1",null,"🎛️ 性能配置管理"),i("p",{class:"description"},"管理GOST系统的性能参数和运行模式")],-1)),c(ie,{class:"mode-card",shadow:"hover"},{header:u((()=>[i("div",b,[a[12]||(a[12]=i("span",null,"🔧 系统运行模式",-1)),c(y,{type:"simple"===l.currentMode?"danger":"success"},{default:u((()=>[g(h("simple"===l.currentMode?"单机模式":"自动模式"),1)])),_:1},8,["type"])])])),default:u((()=>[i("div",P,[i("div",w,["simple"===l.currentMode?(p(),o("div",M,[c(C,{title:"单机模式已启用",type:"warning",description:"所有自动化功能已禁用，需要手动重启GOST服务来同步配置","show-icon":"",closable:!1}),i("div",V,[c(T,{type:"primary",size:"large",loading:l.manualSyncLoading,onClick:l.handleManualSync},{default:u((()=>a[13]||(a[13]=[i("i",{class:"el-icon-refresh"},null,-1),g(" 手动同步GOST配置 ")]))),_:1,__:[13]},8,["loading","onClick"]),a[14]||(a[14]=i("p",{class:"sync-tip"},"点击此按钮将重新生成GOST配置并重启服务",-1))])])):(p(),o("div",k,[c(C,{title:"自动模式已启用",type:"success",description:"所有自动化功能正常运行，配置变更将自动同步","show-icon":"",closable:!1})]))]),i("div",x,[c(S,{modelValue:l.isSimpleMode,"onUpdate:modelValue":a[0]||(a[0]=e=>l.isSimpleMode=e),"active-text":"单机模式","inactive-text":"自动模式","active-color":"#f56c6c","inactive-color":"#67c23a",loading:l.modeSwitchLoading,onChange:l.handleModeSwitch},null,8,["modelValue","loading","onChange"])])])])),_:1}),l.isSimpleMode?r("",!0):(p(),d(ie,{key:0,class:"preset-card",shadow:"hover"},{header:u((()=>a[15]||(a[15]=[i("span",null,"🎯 性能预设配置",-1)]))),default:u((()=>[i("div",I,[(p(!0),o(f,null,v(l.presets,((e,a)=>(p(),d(T,{key:a,type:l.getPresetButtonType(a),loading:l.presetLoading===a,onClick:e=>l.applyPreset(a)},{default:u((()=>[g(h(e.name),1)])),_:2},1032,["type","loading","onClick"])))),128))]),i("div",L,[(p(!0),o(f,null,v(l.presets,((e,a)=>(p(),o("div",{key:a,class:"preset-item"},[i("h4",null,h(e.name),1),i("p",null,h(e.description),1)])))),128))]),c(C,{title:"提示",type:"info",description:"性能预设会覆盖当前的详细配置参数，应用后可以在下方详细配置中进一步调整","show-icon":"",closable:!1,style:{"margin-top":"15px"}})])),_:1})),c(ie,{class:"protocol-card",shadow:"hover"},{header:u((()=>[i("div",O,[a[17]||(a[17]=i("span",null,"🚫 协议屏蔽配置",-1)),c(T,{type:"primary",size:"small",onClick:l.saveProtocolConfig,loading:l.protocolSaveLoading},{default:u((()=>a[16]||(a[16]=[g(" 保存配置 ")]))),_:1,__:[16]},8,["onClick","loading"])])])),default:u((()=>[i("div",z,[a[21]||(a[21]=i("p",{class:"section-desc"},"选择需要禁用的转发协议，被禁用的协议将无法创建新规则或转发流量",-1)),i("div",U,[c(ue,{modelValue:l.disabledProtocols,"onUpdate:modelValue":a[1]||(a[1]=e=>l.disabledProtocols=e)},{default:u((()=>[c(ce,{label:"socks"},{default:u((()=>a[18]||(a[18]=[g("SOCKS 协议")]))),_:1,__:[18]}),c(ce,{label:"http"},{default:u((()=>a[19]||(a[19]=[g("HTTP 协议")]))),_:1,__:[19]}),c(ce,{label:"tls"},{default:u((()=>a[20]||(a[20]=[g("TLS 协议")]))),_:1,__:[20]})])),_:1},8,["modelValue"])]),l.disabledProtocols.length>0?(p(),d(C,{key:0,title:"警告：禁用协议将立即生效",type:"warning",description:"禁用协议后，所有使用该协议的转发规则将停止工作，直到重新启用该协议","show-icon":"",closable:!1,style:{"margin-top":"15px"}})):r("",!0)])])),_:1}),l.isSimpleMode?r("",!0):(p(),d(ie,{key:1,class:"config-card",shadow:"hover"},{header:u((()=>[i("div",H,[a[23]||(a[23]=i("span",null,"⚙️ 详细配置参数",-1)),c(T,{type:"primary",size:"small",onClick:l.saveConfig,loading:l.saveLoading},{default:u((()=>a[22]||(a[22]=[g(" 保存配置 ")]))),_:1,__:[22]},8,["onClick","loading"])])])),default:u((()=>[c(ge,{modelValue:l.activeTab,"onUpdate:modelValue":a[11]||(a[11]=e=>l.activeTab=e),type:"border-card"},{default:u((()=>[c(pe,{label:"🔌 GOST插件",name:"plugins"},{default:u((()=>[i("div",G,[a[29]||(a[29]=i("h3",null,"插件超时配置",-1)),a[30]||(a[30]=i("p",{class:"section-desc"},"控制GOST插件的响应超时时间，直接影响转发性能",-1)),c(me,{gutter:20},{default:u((()=>[c(re,{span:8},{default:u((()=>[i("div",B,[a[24]||(a[24]=i("label",null,"认证器超时 (秒)",-1)),c(de,{modelValue:l.configForm.gostPlugins.authTimeout,"onUpdate:modelValue":a[2]||(a[2]=e=>l.configForm.gostPlugins.authTimeout=e),min:1,max:60,size:"small"},null,8,["modelValue"]),i("p",A,h(l.getParamHelp("gostPlugins","authTimeout")),1)])])),_:1}),c(re,{span:8},{default:u((()=>[i("div",F,[a[25]||(a[25]=i("label",null,"观察器超时 (秒)",-1)),c(de,{modelValue:l.configForm.gostPlugins.observerTimeout,"onUpdate:modelValue":a[3]||(a[3]=e=>l.configForm.gostPlugins.observerTimeout=e),min:1,max:60,size:"small"},null,8,["modelValue"]),i("p",j,h(l.getParamHelp("gostPlugins","observerTimeout")),1)])])),_:1})])),_:1}),c(me,{gutter:20,style:{"margin-top":"20px"}},{default:u((()=>[c(re,{span:8},{default:u((()=>[i("div",$,[a[26]||(a[26]=i("label",null,"观察器周期 (秒)",-1)),c(de,{modelValue:l.observerPeriodSeconds,"onUpdate:modelValue":a[4]||(a[4]=e=>l.observerPeriodSeconds=e),min:5,max:300,size:"small",onChange:l.updateObserverPeriod},null,8,["modelValue","onChange"]),a[27]||(a[27]=i("p",{class:"param-help"},"GOST观察器报告流量统计的周期，影响流量统计的实时性",-1))])])),_:1}),c(re,{span:8},{default:u((()=>[i("div",K,[a[28]||(a[28]=i("label",null,"限制器超时 (秒)",-1)),c(de,{modelValue:l.configForm.gostPlugins.limiterTimeout,"onUpdate:modelValue":a[5]||(a[5]=e=>l.configForm.gostPlugins.limiterTimeout=e),min:1,max:60,size:"small"},null,8,["modelValue"]),i("p",N,h(l.getParamHelp("gostPlugins","limiterTimeout")),1)])])),_:1})])),_:1})])])),_:1}),c(pe,{label:"💾 缓存配置",name:"cache"},{default:u((()=>[i("div",R,[a[35]||(a[35]=i("h3",null,"缓存超时配置",-1)),a[36]||(a[36]=i("p",{class:"section-desc"},"控制各种缓存的生存时间，影响查询性能和实时性",-1)),c(me,{gutter:20},{default:u((()=>[c(re,{span:8},{default:u((()=>[i("div",D,[a[31]||(a[31]=i("label",null,"认证器缓存 (分钟)",-1)),c(de,{modelValue:l.authCacheMinutes,"onUpdate:modelValue":a[6]||(a[6]=e=>l.authCacheMinutes=e),min:1,max:60,size:"small",onChange:l.updateAuthCacheTimeout},null,8,["modelValue","onChange"]),i("p",E,h(l.getParamHelp("cacheConfig","authCacheTimeout")),1)])])),_:1}),c(re,{span:8},{default:u((()=>[i("div",X,[a[32]||(a[32]=i("label",null,"限制器缓存 (分钟)",-1)),c(de,{modelValue:l.limiterCacheMinutes,"onUpdate:modelValue":a[7]||(a[7]=e=>l.limiterCacheMinutes=e),min:.5,max:30,step:.5,size:"small",onChange:l.updateLimiterCacheTimeout},null,8,["modelValue","onChange"]),i("p",q,h(l.getParamHelp("cacheConfig","limiterCacheTimeout")),1)])])),_:1}),c(re,{span:8},{default:u((()=>[i("div",J,[a[33]||(a[33]=i("label",null,"多实例缓存 (分钟)",-1)),c(de,{modelValue:l.multiInstanceCacheMinutes,"onUpdate:modelValue":a[8]||(a[8]=e=>l.multiInstanceCacheMinutes=e),min:.5,max:10,step:.5,size:"small",onChange:l.updateMultiInstanceCacheTTL},null,8,["modelValue","onChange"]),a[34]||(a[34]=i("p",{class:"param-help"},"多实例缓存的生存时间",-1))])])),_:1})])),_:1})])])),_:1}),c(pe,{label:"🔄 同步配置",name:"sync"},{default:u((()=>[i("div",Q,[a[39]||(a[39]=i("h3",null,"同步频率配置",-1)),a[40]||(a[40]=i("p",{class:"section-desc"},"控制各种自动同步的频率，影响系统响应速度和资源消耗",-1)),c(me,{gutter:20},{default:u((()=>[c(re,{span:12},{default:u((()=>[i("div",W,[a[37]||(a[37]=i("label",null,"自动同步间隔 (分钟)",-1)),c(de,{modelValue:l.autoSyncMinutes,"onUpdate:modelValue":a[9]||(a[9]=e=>l.autoSyncMinutes=e),min:1,max:60,size:"small",onChange:l.updateAutoSyncInterval},null,8,["modelValue","onChange"]),i("p",Y,h(l.getParamHelp("syncConfig","autoSyncInterval")),1)])])),_:1}),c(re,{span:12},{default:u((()=>[i("div",Z,[a[38]||(a[38]=i("label",null,"健康检查间隔 (分钟)",-1)),c(de,{modelValue:l.healthCheckMinutes,"onUpdate:modelValue":a[10]||(a[10]=e=>l.healthCheckMinutes=e),min:.5,max:10,step:.5,size:"small",onChange:l.updateHealthCheckInterval},null,8,["modelValue","onChange"]),i("p",ee,h(l.getParamHelp("syncConfig","healthCheckInterval")),1)])])),_:1})])),_:1})])])),_:1})])),_:1},8,["modelValue"])])),_:1})),c(ie,{class:"status-card",shadow:"hover"},{header:u((()=>[i("div",ae,[a[42]||(a[42]=i("span",null,"📊 系统状态",-1)),c(T,{size:"small",onClick:l.refreshStatus,loading:l.statusLoading},{default:u((()=>a[41]||(a[41]=[g(" 刷新状态 ")]))),_:1,__:[41]},8,["onClick","loading"])])])),default:u((()=>{var e;return[i("div",te,[c(me,{gutter:20},{default:u((()=>[c(re,{span:8},{default:u((()=>{var e;return[i("div",le,[a[43]||(a[43]=i("h4",null,"🎛️ 运行模式",-1)),c(y,{type:(null==(e=l.systemStatus.mode)?void 0:e.isSimpleMode)?"danger":"success"},{default:u((()=>{var e;return[g(h((null==(e=l.systemStatus.mode)?void 0:e.isSimpleMode)?"单机模式":"自动模式"),1)]})),_:1},8,["type"])])]})),_:1}),c(re,{span:8},{default:u((()=>{var e,t;return[i("div",se,[a[44]||(a[44]=i("h4",null,"🚀 GOST服务",-1)),c(y,{type:(null==(t=null==(e=l.systemStatus.services)?void 0:e.gost)?void 0:t.isRunning)?"success":"danger"},{default:u((()=>{var e,a;return[g(h((null==(a=null==(e=l.systemStatus.services)?void 0:e.gost)?void 0:a.isRunning)?"运行中":"已停止"),1)]})),_:1},8,["type"])])]})),_:1}),c(re,{span:8},{default:u((()=>{var e;return[i("div",ne,[a[45]||(a[45]=i("h4",null,"🔧 配置版本",-1)),i("span",null,"v"+h((null==(e=l.systemStatus.config)?void 0:e.configVersion)||0),1)])]})),_:1})])),_:1}),(null==(e=l.systemStatus.config)?void 0:e.lastUpdated)?(p(),o("div",oe,[i("p",null,"最后更新: "+h(l.formatTime(l.systemStatus.config.lastUpdated)),1),i("p",null,"更新者: "+h(l.systemStatus.config.lastUpdatedBy||"未知"),1)])):r("",!0)])]})),_:1})])}],["__scopeId","data-v-9649721f"]]);export{ie as default};
