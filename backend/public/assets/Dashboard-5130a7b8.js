import{ax as a,r as e,c as t,k as s,n as l,z as r,P as o,H as c,G as u,K as i,ag as d,aq as n,y as v,A as f,u as p,L as h,I as g,C as y,M as m}from"./vue-55dd3248.js";import{E as _,r as w,e as b}from"./element-plus-0a16f2db.js";import{i as x}from"./charts-d42137db.js";import{_ as k}from"./index-75dfb4d4.js";import"./utils-d4f80f06.js";const S={class:"dashboard"},G={class:"card-header"},M={class:"stat-card"},D={class:"stat-card"},$={class:"stat-value"},z={class:"stat-card"},P={class:"stat-value"},A={class:"card-header"},F={class:"card-header"},L={class:"stat-card"},T={class:"stat-value"},j={class:"stat-card"},B={class:"stat-value"},C={class:"stat-card"},O={class:"stat-value"},E=k({__name:"Dashboard",setup(k){const E=a(),I=e(!1),H=e(null),K=e("today"),N=e(!1),R=e(null),q=e(null);let U=null;const J=t((()=>E.getters["gost/isRunning"])),Q=t((()=>E.getters["gost/portForwards"])),V=t((()=>E.getters["gost/systemInfo"])),W=t((()=>E.getters["user/isAdmin"])),X=async()=>{try{I.value=!0,H.value=await E.dispatch("traffic/fetchStats"),console.log("📊 Stats refreshed:",H.value)}catch(a){console.error("❌ Failed to refresh stats:",a),_.error(a.message||"获取统计数据失败")}finally{I.value=!1}},Y=async()=>{try{N.value=!0,R.value=await E.dispatch("gost/fetchStatus"),console.log("🔧 GOST status refreshed:",R.value),console.log("🔧 GOST running:",J.value),console.log("🔧 Port forwards:",Q.value)}catch(a){console.error("❌ Failed to refresh GOST status:",a),_.error(a.message||"获取Gost服务状态失败")}finally{N.value=!1}},Z=async()=>{try{await E.dispatch("gost/startService"),_.success("Gost服务启动成功")}catch(a){_.error(a.message||"启动Gost服务失败")}},aa=async()=>{try{await E.dispatch("gost/stopService"),_.success("Gost服务已停止")}catch(a){_.error(a.message||"停止Gost服务失败")}},ea=async()=>{try{await E.dispatch("gost/restartService"),_.success("Gost服务已重启")}catch(a){_.error(a.message||"重启Gost服务失败")}},ta=a=>{if(0===a)return"0 B";const e=Math.floor(Math.log(a)/Math.log(1024));return parseFloat((a/Math.pow(1024,e)).toFixed(2))+" "+["B","KB","MB","GB","TB"][e]},sa=a=>{if(!a)return"未知";const e=Math.floor(a/86400),t=Math.floor(a%86400/3600);let s="";return e>0&&(s+=`${e}天 `),(t>0||e>0)&&(s+=`${t}小时 `),s+=`${Math.floor(a%3600/60)}分钟`,s};return s((async()=>{X(),Y(),await l(),(()=>{if(q.value&&!U){U=x(q.value);const a={title:{text:"流量趋势",left:"center",textStyle:{fontSize:16,color:"#333"}},tooltip:{trigger:"axis",formatter:function(a){const e=a[0];return`${e.name}<br/>${e.seriesName}: ${ta(e.value)}`}},xAxis:{type:"category",data:[],axisLabel:{color:"#666"}},yAxis:{type:"value",axisLabel:{color:"#666",formatter:function(a){return ta(a)}}},series:[{name:"流量",type:"line",data:[],smooth:!0,lineStyle:{color:"#409EFF"},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(64, 158, 255, 0.3)"},{offset:1,color:"rgba(64, 158, 255, 0.1)"}]}}}]};U.setOption(a),window.addEventListener("resize",(()=>{U&&U.resize()}))}})(),(async()=>{try{const a=await fetch("/api/dashboard/traffic-trend?days="+("today"===K.value?1:"week"===K.value?7:30)),e=await a.json();if(U){const a=[],t=[];if(e.success&&e.data&&0!==e.data.length)e.data.forEach((e=>{const s=new Date(e.date);a.push(s.toLocaleDateString()),t.push(e.traffic)}));else{console.log("生成示例流量数据用于图表显示");const e=new Date;for(let s=("today"===K.value?1:"week"===K.value?7:30)-1;s>=0;s--){const l=new Date(e.getTime()-24*s*60*60*1e3);a.push(l.toLocaleDateString()),t.push(1024*(150*Math.random()+50)*1024)}}U.setOption({xAxis:{data:a},series:[{data:t}]})}}catch(a){if(console.error("获取流量趋势失败:",a),U){const a=[],e=[],t=new Date;for(let s=6;s>=0;s--){const l=new Date(t.getTime()-24*s*60*60*1e3);a.push(l.toLocaleDateString()),e.push(1024*(150*Math.random()+50)*1024)}U.setOption({xAxis:{data:a},series:[{data:e}]})}}})()})),(a,e)=>{var t;const s=d("el-icon"),l=d("el-button"),_=d("el-col"),x=d("el-row"),k=d("el-card"),E=d("el-tag"),K=d("el-table-column"),q=d("el-table");d("el-option"),d("el-select");const U=n("loading");return v(),r("div",S,[o(k,{class:"dashboard-card"},{header:c((()=>[f("div",G,[e[4]||(e[4]=f("span",null,"Gost服务状态",-1)),f("div",null,[o(l,{link:"",onClick:Y},{default:c((()=>[o(s,null,{default:c((()=>[o(p(w))])),_:1})])),_:1}),!J.value&&W.value?(v(),u(l,{key:0,type:"success",size:"small",onClick:Z},{default:c((()=>e[1]||(e[1]=[h(" 启动服务 ")]))),_:1,__:[1]})):i("",!0),J.value&&W.value?(v(),u(l,{key:1,type:"danger",size:"small",onClick:aa},{default:c((()=>e[2]||(e[2]=[h(" 停止服务 ")]))),_:1,__:[2]})):i("",!0),W.value?(v(),u(l,{key:2,type:"primary",size:"small",onClick:ea},{default:c((()=>e[3]||(e[3]=[h(" 重启服务 ")]))),_:1,__:[3]})):i("",!0)])])])),default:c((()=>[g((v(),u(x,{gutter:20},{default:c((()=>[o(_,{span:8},{default:c((()=>[f("div",M,[e[5]||(e[5]=f("div",{class:"stat-title"},"服务状态",-1)),f("div",{class:y(["stat-value",{success:J.value,danger:!J.value}])},m(J.value?"运行中":"已停止"),3)])])),_:1}),J.value?(v(),u(_,{key:0,span:8},{default:c((()=>{var a;return[f("div",D,[e[6]||(e[6]=f("div",{class:"stat-title"},"进程ID",-1)),f("div",$,m(W.value?(null==(a=R.value)?void 0:a.pid)||"N/A":"****"),1)])]})),_:1})):i("",!0),J.value&&V.value?(v(),u(_,{key:1,span:8},{default:c((()=>[f("div",z,[e[7]||(e[7]=f("div",{class:"stat-title"},"运行时间",-1)),f("div",P,m(W.value?sa(V.value.uptime):"****"),1)])])),_:1})):i("",!0)])),_:1})),[[U,N.value]])])),_:1}),(null==(t=Q.value)?void 0:t.length)>0?(v(),u(k,{key:0,class:"dashboard-card"},{header:c((()=>[f("div",A,[e[8]||(e[8]=f("span",null,"端口转发详情",-1)),o(E,{effect:"dark",size:"small",type:"success"},{default:c((()=>[h(m(Q.value.length)+" 个活跃规则",1)])),_:1})])])),default:c((()=>[g((v(),u(q,{data:Q.value,stripe:"",style:{width:"100%"}},{default:c((()=>[o(K,{label:"名称"},{default:c((a=>[h(m(W.value?a.row.name:"****"),1)])),_:1}),o(K,{prop:"protocol",label:"协议"}),o(K,{label:"转发规则"},{default:c((a=>[o(E,{type:"primary"},{default:c((()=>[h(m(a.row.sourcePort||a.row.localPort)+" ",1),o(s,null,{default:c((()=>[o(p(b))])),_:1}),h(" "+m(W.value?`${a.row.targetHost}:${a.row.targetPort}`:"****:****"),1)])),_:2},1024)])),_:1}),o(K,{label:"源端口",width:"80"},{default:c((a=>[h(m(a.row.sourcePort||a.row.localPort),1)])),_:1}),o(K,{label:"目标地址",width:"150"},{default:c((a=>[h(m(W.value?`${a.row.targetHost}:${a.row.targetPort}`:"****:****"),1)])),_:1})])),_:1},8,["data"])),[[U,N.value]])])),_:1})):i("",!0),o(k,{class:"dashboard-card"},{header:c((()=>[f("div",F,[e[9]||(e[9]=f("span",null,"系统概览",-1)),o(l,{link:"",onClick:X},{default:c((()=>[o(s,null,{default:c((()=>[o(p(w))])),_:1})])),_:1})])])),default:c((()=>[g((v(),u(x,{gutter:20},{default:c((()=>[o(_,{span:8},{default:c((()=>{var a;return[f("div",L,[e[10]||(e[10]=f("div",{class:"stat-title"},"活跃用户",-1)),f("div",T,m(W.value?(null==(a=H.value)?void 0:a.activeUsers)||0:"****"),1)])]})),_:1}),o(_,{span:8},{default:c((()=>{var a;return[f("div",j,[e[11]||(e[11]=f("div",{class:"stat-title"},"活跃规则",-1)),f("div",B,m((null==(a=H.value)?void 0:a.activeRules)||0),1)])]})),_:1}),o(_,{span:8},{default:c((()=>{var a;return[f("div",C,[e[12]||(e[12]=f("div",{class:"stat-title"},"总流量",-1)),f("div",O,m(W.value?ta((null==(a=H.value)?void 0:a.totalTraffic)||0):"****"),1)])]})),_:1})])),_:1})),[[U,I.value]])])),_:1}),i("",!0)])}}},[["__scopeId","data-v-27308f6b"]]);export{E as default};
