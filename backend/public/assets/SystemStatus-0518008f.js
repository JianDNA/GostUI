import{ax as a,ay as l,c as s,r as e,k as t,S as n,z as u,A as i,P as r,H as o,ag as v,aq as d,y as c,u as g,L as f,G as p,I as _,M as y,C as h}from"./vue-55dd3248.js";import{E as m,r as S,m as R,n as P,o as G,s as T,c as w,q as O,v as k}from"./element-plus-0a16f2db.js";import{a as A}from"./api-814d2442.js";import{_ as C}from"./index-75dfb4d4.js";import"./utils-d4f80f06.js";const I={class:"system-status"},z={class:"page-header"},M={class:"header-actions"},F={class:"card-header"},B={class:"header-left"},j={class:"stat-card"},x={class:"stat-value"},E={class:"stat-card"},b={class:"stat-value"},$={class:"stat-card"},q={class:"stat-value"},U={class:"stat-card"},D={class:"stat-value"},H={class:"card-header"},K={class:"header-left"},L={class:"service-card"},J={class:"service-title"},N={class:"service-card"},Q={class:"service-title"},V={class:"service-card"},W={class:"service-title"},X={class:"card-header"},Y={class:"header-left"},Z={class:"header-actions"},aa={class:"stat-card gost-stat-card"},la={class:"stat-icon"},sa={class:"stat-card gost-stat-card"},ea={class:"stat-icon"},ta={class:"stat-value"},na={class:"stat-card gost-stat-card"},ua={class:"stat-icon"},ia={class:"stat-value"},ra=C({__name:"SystemStatus",setup(C){const ra=a(),oa=l();s((()=>ra.getters["user/isAdmin"])).value||(m.error("此功能仅限管理员使用"),oa.push("/dashboard"));const va=e(!1),da=e(!1),ca=e(!1),ga=e(null),fa=e(null),pa=e(null),_a=e(null),ya=e(null),ha=e(null),ma=e(null);let Sa=null;const Ra=s((()=>{var a,l,s,e,t;if(!ga.value)return!1;const n=!0===(null==(a=ha.value)?void 0:a.isRunning),u=!1!==(null==(l=pa.value)?void 0:l.isRunning),i=!1!==(null==(s=_a.value)?void 0:s.isRunning),r=!1!==(null==(e=ya.value)?void 0:e.isRunning),o=!1!==(null==(t=ma.value)?void 0:t.isRunning);return n&&u&&i&&r&&o})),Pa=async()=>{var a,l;try{va.value=!0,console.log("🔄 刷新系统状态...");const[e,t,n]=await Promise.allSettled([A.system.getStatus(),ra.dispatch("traffic/fetchStats"),A.system.getGostStatus()]);if("fulfilled"===e.status?(ga.value=e.value.data.data,console.log("✅ 系统状态获取成功:",ga.value)):console.warn("⚠️ 系统状态获取失败:",e.reason),"fulfilled"===t.status?(fa.value={users:{total:t.value.totalUsers||0,active:t.value.activeUsers||0},rules:{total:t.value.activeRules||0},traffic:{total:t.value.totalTraffic||0}},console.log("✅ 统计数据获取成功:",fa.value)):(console.warn("⚠️ 统计数据获取失败:",t.reason),fa.value={users:{total:0,active:0},rules:{total:0},traffic:{total:0}}),"fulfilled"===n.status)ha.value=n.value.data.data,console.log("✅ GOST状态获取成功:",ha.value);else{console.warn("⚠️ GOST状态获取失败:",n.reason);if(401===(null==(l=null==(a=n.reason)?void 0:a.response)?void 0:l.status)){console.warn("🔐 GOST状态获取失败：认证错误，尝试使用备用API");try{const a=await A.gost.getStatus();ha.value={isRunning:a.data.data.isRunning,apiPort:"18080",healthyPorts:[],fallbackMode:!0},console.log("✅ 使用备用API获取GOST状态成功:",ha.value)}catch(s){console.error("❌ 备用API也失败了:",s),ha.value||(ha.value={isRunning:null,apiPort:"18080",healthyPorts:[],error:"无法获取状态"})}}else console.error("❌ GOST状态获取失败（非认证错误）:",n.reason),ha.value||(ha.value={isRunning:null,apiPort:"18080",healthyPorts:[],error:"网络错误或服务不可用"})}pa.value={isRunning:!0,stats:{checksPerformed:0,violationsFound:0}},_a.value={isRunning:!0,stats:{activeUsers:0,quotaChecks:0}},ya.value={isRunning:!0,stats:{lastSync:(new Date).toISOString(),syncCount:0}},ma.value={isRunning:!0,port:18081}}catch(e){console.error("❌ 获取系统状态失败:",e),m.error("获取系统状态失败: "+(e.message||"未知错误"))}finally{va.value=!1}},Ga=async()=>{var a;try{da.value=!0;const a=await A.system.getGostStatus();ha.value=a.data.data,console.log("✅ GOST状态刷新成功:",ha.value)}catch(l){console.error("获取GOST状态失败:",l);if(401===(null==(a=null==l?void 0:l.response)?void 0:a.status)){console.warn("🔐 GOST状态刷新失败：认证错误，尝试使用备用API");try{const a=await A.gost.getStatus();ha.value={isRunning:a.data.data.isRunning,apiPort:"18080",healthyPorts:[],fallbackMode:!0},console.log("✅ 使用备用API刷新GOST状态成功:",ha.value),m.success("已使用备用方式获取GOST状态")}catch(s){console.error("❌ 备用API也失败了:",s),m.error("无法获取GOST状态，请检查服务状态"),ha.value||(ha.value={isRunning:null,apiPort:"18080",healthyPorts:[],error:"无法获取状态"})}}else m.error("获取GOST状态失败: "+(l.message||"未知错误")),ha.value||(ha.value={isRunning:null,apiPort:"18080",healthyPorts:[],error:"网络错误或服务不可用"})}finally{da.value=!1}},Ta=async()=>{try{ca.value=!0,await A.system.forceSync(),m.success("强制同步已触发"),setTimeout(Pa,2e3)}catch(a){console.error("强制同步失败:",a),m.error("强制同步失败")}finally{ca.value=!1}},wa=async()=>{try{da.value=!0,await A.system.restartGost(),m.success("GOST服务重启成功"),setTimeout(Ga,3e3)}catch(a){console.error("重启GOST失败:",a),m.error("重启GOST失败")}finally{da.value=!1}},Oa=a=>{if(!a)return"未知";const l=Math.floor(a/86400),s=Math.floor(a%86400/3600);let e="";return l>0&&(e+=`${l}天 `),(s>0||l>0)&&(e+=`${s}小时 `),e+=`${Math.floor(a%3600/60)}分钟`,e},ka=a=>{if(!a||0===a)return"0 B";const l=Math.floor(Math.log(a)/Math.log(1024));return parseFloat((a/Math.pow(1024,l)).toFixed(2))+" "+["B","KB","MB","GB","TB"][l]};return t((()=>{Pa(),Sa=setInterval(Pa,3e4)})),n((()=>{Sa&&clearInterval(Sa)})),(a,l)=>{const s=v("el-page-header"),e=v("el-icon"),t=v("el-button"),n=v("el-tag"),m=v("el-col"),A=v("el-row"),C=v("el-card"),ra=d("loading");return c(),u("div",I,[i("div",z,[r(s,{onBack:l[0]||(l[0]=l=>a.$router.go(-1)),content:"系统状态监控"}),i("div",M,[r(t,{type:"primary",onClick:Pa,loading:va.value},{default:o((()=>[r(e,null,{default:o((()=>[r(g(S))])),_:1}),l[1]||(l[1]=f(" 刷新状态 "))])),_:1,__:[1]},8,["loading"])])]),r(C,{class:"status-card overview-card"},{header:o((()=>[i("div",F,[i("div",B,[r(e,{size:"20",color:"#409EFF"},{default:o((()=>[r(g(R))])),_:1}),l[2]||(l[2]=i("span",null,"系统概览",-1))]),Ra.value?(c(),p(n,{key:0,type:"success",size:"large"},{default:o((()=>[r(e,null,{default:o((()=>[r(g(P))])),_:1}),l[3]||(l[3]=f(" 系统正常 "))])),_:1,__:[3]})):(c(),p(n,{key:1,type:"danger",size:"large"},{default:o((()=>[r(e,null,{default:o((()=>[r(g(G))])),_:1}),l[4]||(l[4]=f(" 系统异常 "))])),_:1,__:[4]}))])])),default:o((()=>[_((c(),p(A,{gutter:20},{default:o((()=>[r(m,{span:6},{default:o((()=>{var a;return[i("div",j,[l[5]||(l[5]=i("div",{class:"stat-title"},"系统运行时间",-1)),i("div",x,y(Oa(null==(a=ga.value)?void 0:a.uptime)),1)])]})),_:1}),r(m,{span:6},{default:o((()=>{var a,s;return[i("div",E,[l[6]||(l[6]=i("div",{class:"stat-title"},"总用户数",-1)),i("div",b,y((null==(s=null==(a=fa.value)?void 0:a.users)?void 0:s.total)||0),1)])]})),_:1}),r(m,{span:6},{default:o((()=>{var a,s;return[i("div",$,[l[7]||(l[7]=i("div",{class:"stat-title"},"活跃规则",-1)),i("div",q,y((null==(s=null==(a=fa.value)?void 0:a.rules)?void 0:s.total)||0),1)])]})),_:1}),r(m,{span:6},{default:o((()=>{var a,s;return[i("div",U,[l[8]||(l[8]=i("div",{class:"stat-title"},"总流量",-1)),i("div",D,y(ka(null==(s=null==(a=fa.value)?void 0:a.traffic)?void 0:s.total)),1)])]})),_:1})])),_:1})),[[ra,va.value]])])),_:1}),r(C,{class:"status-card services-card"},{header:o((()=>[i("div",H,[i("div",K,[r(e,{size:"20",color:"#67C23A"},{default:o((()=>[r(g(T))])),_:1}),l[9]||(l[9]=i("span",null,"服务状态",-1))]),r(t,{type:"primary",size:"small",onClick:Ta,loading:ca.value},{default:o((()=>[r(e,null,{default:o((()=>[r(g(S))])),_:1}),l[10]||(l[10]=f(" 强制同步 "))])),_:1,__:[10]},8,["loading"])])])),default:o((()=>[_((c(),p(A,{gutter:20},{default:o((()=>[r(m,{span:8},{default:o((()=>{var a,s;return[i("div",L,[i("div",J,[r(e,null,{default:o((()=>[r(g(R))])),_:1}),l[11]||(l[11]=f(" 实时监控 "))]),i("div",{class:h(["service-status",{running:null==(a=pa.value)?void 0:a.isRunning}])},y((null==(s=pa.value)?void 0:s.isRunning)?"运行中":"已停止"),3),l[12]||(l[12]=i("div",{class:"service-details"},[i("p",null,"流量监控服务")],-1))])]})),_:1}),r(m,{span:8},{default:o((()=>[i("div",N,[i("div",Q,[r(e,null,{default:o((()=>[r(g(T))])),_:1}),l[13]||(l[13]=f(" 配额协调器 "))]),l[14]||(l[14]=i("div",{class:"service-status running"}," 运行中 ",-1)),l[15]||(l[15]=i("div",{class:"service-details"},[i("p",null,"用户配额管理")],-1))])])),_:1}),r(m,{span:8},{default:o((()=>{var a,s;return[i("div",V,[i("div",W,[r(e,null,{default:o((()=>[r(g(w))])),_:1}),l[16]||(l[16]=f(" 同步协调器 "))]),i("div",{class:h(["service-status",{running:!(null==(a=ya.value)?void 0:a.isSyncing)}])},y((null==(s=ya.value)?void 0:s.isSyncing)?"同步中":"空闲"),3),l[17]||(l[17]=i("div",{class:"service-details"},[i("p",null,"配置同步服务")],-1))])]})),_:1})])),_:1})),[[ra,va.value]])])),_:1}),r(C,{class:"status-card gost-card"},{header:o((()=>{var a,s;return[i("div",X,[i("div",Y,[l[18]||(l[18]=i("span",null,"GOST服务状态",-1)),r(n,{type:!0===(null==(a=ha.value)?void 0:a.isRunning)?"success":!1===(null==(s=ha.value)?void 0:s.isRunning)?"danger":"warning",size:"small",style:{"margin-left":"12px"}},{default:o((()=>{var a,l;return[f(y(!0===(null==(a=ha.value)?void 0:a.isRunning)?"运行中":!1===(null==(l=ha.value)?void 0:l.isRunning)?"已停止":"状态未知"),1)]})),_:1},8,["type"])]),i("div",Z,[r(t,{link:"",onClick:Ga,loading:da.value},{default:o((()=>[r(e,null,{default:o((()=>[r(g(S))])),_:1}),l[19]||(l[19]=f(" 刷新 "))])),_:1,__:[19]},8,["loading"]),r(t,{type:"warning",size:"small",onClick:wa,loading:da.value},{default:o((()=>[r(e,null,{default:o((()=>[r(g(O))])),_:1}),l[20]||(l[20]=f(" 重启服务 "))])),_:1,__:[20]},8,["loading"])])])]})),default:o((()=>[_((c(),p(A,{gutter:20},{default:o((()=>[r(m,{span:8},{default:o((()=>{var a,s,t,n,u,v,d;return[i("div",aa,[i("div",la,[r(e,{size:"24",color:!0===(null==(a=ha.value)?void 0:a.isRunning)?"#67C23A":!1===(null==(s=ha.value)?void 0:s.isRunning)?"#F56C6C":"#E6A23C"},{default:o((()=>[r(g(R))])),_:1},8,["color"])]),l[21]||(l[21]=i("div",{class:"stat-title"},"服务状态",-1)),i("div",{class:h(["stat-value",{success:!0===(null==(t=ha.value)?void 0:t.isRunning),danger:!1===(null==(n=ha.value)?void 0:n.isRunning),warning:null===(null==(u=ha.value)?void 0:u.isRunning)}])},y(!0===(null==(v=ha.value)?void 0:v.isRunning)?"运行中":!1===(null==(d=ha.value)?void 0:d.isRunning)?"已停止":"状态未知"),3)])]})),_:1}),r(m,{span:8},{default:o((()=>{var a;return[i("div",sa,[i("div",ea,[r(e,{size:"24",color:"#409EFF"},{default:o((()=>[r(g(w))])),_:1})]),l[22]||(l[22]=i("div",{class:"stat-title"},"API端口",-1)),i("div",ta,y((null==(a=ha.value)?void 0:a.apiPort)||"18080"),1)])]})),_:1}),r(m,{span:8},{default:o((()=>{var a;return[i("div",na,[i("div",ua,[r(e,{size:"24",color:"#E6A23C"},{default:o((()=>[r(g(k))])),_:1})]),l[23]||(l[23]=i("div",{class:"stat-title"},"观察器端口",-1)),i("div",ia,y((null==(a=ma.value)?void 0:a.port)||"18081"),1)])]})),_:1})])),_:1})),[[ra,da.value]])])),_:1})])}}},[["__scopeId","data-v-90ece43d"]]);export{ra as default};
