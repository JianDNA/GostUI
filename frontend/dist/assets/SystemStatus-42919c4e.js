import{ax as a,ay as l,c as s,r as t,k as e,S as u,z as n,A as i,P as r,H as d,ag as v,aq as c,y as o,u as f,L as g,G as p,I as _,M as y,C as h}from"./vue-9e38bd25.js";import{E as m,r as R,m as S,n as P,o as k,s as w,c as C,q as z,v as G}from"./element-plus-a98c71bf.js";import{a as M}from"./api-c059019c.js";import{_ as T}from"./index-1003864c.js";import"./utils-c29d00eb.js";const F={class:"system-status"},A={class:"page-header"},B={class:"header-actions"},O={class:"card-header"},I={class:"header-left"},j={class:"stat-card"},x={class:"stat-value"},E={class:"stat-card"},b={class:"stat-value"},$={class:"stat-card"},q={class:"stat-value"},U={class:"stat-card"},D={class:"stat-value"},H={class:"card-header"},K={class:"header-left"},L={class:"service-card"},J={class:"service-title"},N={class:"service-card"},Q={class:"service-title"},V={class:"service-card"},W={class:"service-title"},X={class:"card-header"},Y={class:"header-left"},Z={class:"header-actions"},aa={class:"stat-card gost-stat-card"},la={class:"stat-icon"},sa={class:"stat-card gost-stat-card"},ta={class:"stat-icon"},ea={class:"stat-value"},ua={class:"stat-card gost-stat-card"},na={class:"stat-icon"},ia={class:"stat-value"},ra=T({__name:"SystemStatus",setup(T){const ra=a(),da=l();s((()=>ra.getters["user/isAdmin"])).value||(m.error("此功能仅限管理员使用"),da.push("/dashboard"));const va=t(!1),ca=t(!1),oa=t(!1),fa=t(null),ga=t(null),pa=t(null),_a=t(null),ya=t(null),ha=t(null),ma=t(null);let Ra=null;const Sa=s((()=>{var a,l,s,t,e;if(!fa.value)return!1;const u=!0===(null==(a=ha.value)?void 0:a.isRunning),n=!1!==(null==(l=pa.value)?void 0:l.isRunning),i=!1!==(null==(s=_a.value)?void 0:s.isRunning),r=!1!==(null==(t=ya.value)?void 0:t.isRunning),d=!1!==(null==(e=ma.value)?void 0:e.isRunning);return u&&n&&i&&r&&d})),Pa=async()=>{var a,l;try{va.value=!0;const[t,e,u]=await Promise.allSettled([M.system.getStatus(),ra.dispatch("traffic/fetchStats"),M.system.getGostStatus()]);if("fulfilled"===t.status&&(fa.value=t.value.data.data),"fulfilled"===e.status?ga.value={users:{total:e.value.totalUsers||0,active:e.value.activeUsers||0},rules:{total:e.value.activeRules||0},traffic:{total:e.value.totalTraffic||0}}:ga.value={users:{total:0,active:0},rules:{total:0},traffic:{total:0}},"fulfilled"===u.status)ha.value=u.value.data.data;else{if(401===(null==(l=null==(a=u.reason)?void 0:a.response)?void 0:l.status))try{const a=await M.gost.getStatus();ha.value={isRunning:a.data.data.isRunning,apiPort:"18080",healthyPorts:[],fallbackMode:!0}}catch(s){ha.value||(ha.value={isRunning:null,apiPort:"18080",healthyPorts:[],error:"无法获取状态"})}else ha.value||(ha.value={isRunning:null,apiPort:"18080",healthyPorts:[],error:"网络错误或服务不可用"})}pa.value={isRunning:!0,stats:{checksPerformed:0,violationsFound:0}},_a.value={isRunning:!0,stats:{activeUsers:0,quotaChecks:0}},ya.value={isRunning:!0,stats:{lastSync:(new Date).toISOString(),syncCount:0}},ma.value={isRunning:!0,port:18081}}catch(t){m.error("获取系统状态失败: "+(t.message||"未知错误"))}finally{va.value=!1}},ka=async()=>{var a;try{ca.value=!0;const a=await M.system.getGostStatus();ha.value=a.data.data}catch(l){if(401===(null==(a=null==l?void 0:l.response)?void 0:a.status))try{const a=await M.gost.getStatus();ha.value={isRunning:a.data.data.isRunning,apiPort:"18080",healthyPorts:[],fallbackMode:!0},m.success("已使用备用方式获取GOST状态")}catch(s){m.error("无法获取GOST状态，请检查服务状态"),ha.value||(ha.value={isRunning:null,apiPort:"18080",healthyPorts:[],error:"无法获取状态"})}else m.error("获取GOST状态失败: "+(l.message||"未知错误")),ha.value||(ha.value={isRunning:null,apiPort:"18080",healthyPorts:[],error:"网络错误或服务不可用"})}finally{ca.value=!1}},wa=async()=>{try{oa.value=!0,await M.system.forceSync(),m.success("强制同步已触发"),setTimeout(Pa,2e3)}catch(a){m.error("强制同步失败")}finally{oa.value=!1}},Ca=async()=>{try{ca.value=!0,await M.system.restartGost(),m.success("GOST服务重启成功"),setTimeout(ka,3e3)}catch(a){m.error("重启GOST失败")}finally{ca.value=!1}},za=a=>{if(!a)return"未知";const l=Math.floor(a/86400),s=Math.floor(a%86400/3600);let t="";return l>0&&(t+=`${l}天 `),(s>0||l>0)&&(t+=`${s}小时 `),t+=`${Math.floor(a%3600/60)}分钟`,t},Ga=a=>{if(!a||0===a)return"0 B";const l=Math.floor(Math.log(a)/Math.log(1024));return parseFloat((a/Math.pow(1024,l)).toFixed(2))+" "+["B","KB","MB","GB","TB"][l]};return e((()=>{Pa(),Ra=setInterval(Pa,3e4)})),u((()=>{Ra&&clearInterval(Ra)})),(a,l)=>{const s=v("el-page-header"),t=v("el-icon"),e=v("el-button"),u=v("el-tag"),m=v("el-col"),M=v("el-row"),T=v("el-card"),ra=c("loading");return o(),n("div",F,[i("div",A,[r(s,{onBack:l[0]||(l[0]=l=>a.$router.go(-1)),content:"系统状态监控"}),i("div",B,[r(e,{type:"primary",onClick:Pa,loading:va.value},{default:d((()=>[r(t,null,{default:d((()=>[r(f(R))])),_:1}),l[1]||(l[1]=g(" 刷新状态 "))])),_:1,__:[1]},8,["loading"])])]),r(T,{class:"status-card overview-card"},{header:d((()=>[i("div",O,[i("div",I,[r(t,{size:"20",color:"#409EFF"},{default:d((()=>[r(f(S))])),_:1}),l[2]||(l[2]=i("span",null,"系统概览",-1))]),Sa.value?(o(),p(u,{key:0,type:"success",size:"large"},{default:d((()=>[r(t,null,{default:d((()=>[r(f(P))])),_:1}),l[3]||(l[3]=g(" 系统正常 "))])),_:1,__:[3]})):(o(),p(u,{key:1,type:"danger",size:"large"},{default:d((()=>[r(t,null,{default:d((()=>[r(f(k))])),_:1}),l[4]||(l[4]=g(" 系统异常 "))])),_:1,__:[4]}))])])),default:d((()=>[_((o(),p(M,{gutter:20},{default:d((()=>[r(m,{span:6},{default:d((()=>{var a;return[i("div",j,[l[5]||(l[5]=i("div",{class:"stat-title"},"系统运行时间",-1)),i("div",x,y(za(null==(a=fa.value)?void 0:a.uptime)),1)])]})),_:1}),r(m,{span:6},{default:d((()=>{var a,s;return[i("div",E,[l[6]||(l[6]=i("div",{class:"stat-title"},"总用户数",-1)),i("div",b,y((null==(s=null==(a=ga.value)?void 0:a.users)?void 0:s.total)||0),1)])]})),_:1}),r(m,{span:6},{default:d((()=>{var a,s;return[i("div",$,[l[7]||(l[7]=i("div",{class:"stat-title"},"活跃规则",-1)),i("div",q,y((null==(s=null==(a=ga.value)?void 0:a.rules)?void 0:s.total)||0),1)])]})),_:1}),r(m,{span:6},{default:d((()=>{var a,s;return[i("div",U,[l[8]||(l[8]=i("div",{class:"stat-title"},"总流量",-1)),i("div",D,y(Ga(null==(s=null==(a=ga.value)?void 0:a.traffic)?void 0:s.total)),1)])]})),_:1})])),_:1})),[[ra,va.value]])])),_:1}),r(T,{class:"status-card services-card"},{header:d((()=>[i("div",H,[i("div",K,[r(t,{size:"20",color:"#67C23A"},{default:d((()=>[r(f(w))])),_:1}),l[9]||(l[9]=i("span",null,"服务状态",-1))]),r(e,{type:"primary",size:"small",onClick:wa,loading:oa.value},{default:d((()=>[r(t,null,{default:d((()=>[r(f(R))])),_:1}),l[10]||(l[10]=g(" 强制同步 "))])),_:1,__:[10]},8,["loading"])])])),default:d((()=>[_((o(),p(M,{gutter:20},{default:d((()=>[r(m,{span:8},{default:d((()=>{var a,s;return[i("div",L,[i("div",J,[r(t,null,{default:d((()=>[r(f(S))])),_:1}),l[11]||(l[11]=g(" 实时监控 "))]),i("div",{class:h(["service-status",{running:null==(a=pa.value)?void 0:a.isRunning}])},y((null==(s=pa.value)?void 0:s.isRunning)?"运行中":"已停止"),3),l[12]||(l[12]=i("div",{class:"service-details"},[i("p",null,"流量监控服务")],-1))])]})),_:1}),r(m,{span:8},{default:d((()=>[i("div",N,[i("div",Q,[r(t,null,{default:d((()=>[r(f(w))])),_:1}),l[13]||(l[13]=g(" 配额协调器 "))]),l[14]||(l[14]=i("div",{class:"service-status running"}," 运行中 ",-1)),l[15]||(l[15]=i("div",{class:"service-details"},[i("p",null,"用户配额管理")],-1))])])),_:1}),r(m,{span:8},{default:d((()=>{var a,s;return[i("div",V,[i("div",W,[r(t,null,{default:d((()=>[r(f(C))])),_:1}),l[16]||(l[16]=g(" 同步协调器 "))]),i("div",{class:h(["service-status",{running:!(null==(a=ya.value)?void 0:a.isSyncing)}])},y((null==(s=ya.value)?void 0:s.isSyncing)?"同步中":"空闲"),3),l[17]||(l[17]=i("div",{class:"service-details"},[i("p",null,"配置同步服务")],-1))])]})),_:1})])),_:1})),[[ra,va.value]])])),_:1}),r(T,{class:"status-card gost-card"},{header:d((()=>{var a,s;return[i("div",X,[i("div",Y,[l[18]||(l[18]=i("span",null,"GOST服务状态",-1)),r(u,{type:!0===(null==(a=ha.value)?void 0:a.isRunning)?"success":!1===(null==(s=ha.value)?void 0:s.isRunning)?"danger":"warning",size:"small",style:{"margin-left":"12px"}},{default:d((()=>{var a,l;return[g(y(!0===(null==(a=ha.value)?void 0:a.isRunning)?"运行中":!1===(null==(l=ha.value)?void 0:l.isRunning)?"已停止":"状态未知"),1)]})),_:1},8,["type"])]),i("div",Z,[r(e,{link:"",onClick:ka,loading:ca.value},{default:d((()=>[r(t,null,{default:d((()=>[r(f(R))])),_:1}),l[19]||(l[19]=g(" 刷新 "))])),_:1,__:[19]},8,["loading"]),r(e,{type:"warning",size:"small",onClick:Ca,loading:ca.value},{default:d((()=>[r(t,null,{default:d((()=>[r(f(z))])),_:1}),l[20]||(l[20]=g(" 重启服务 "))])),_:1,__:[20]},8,["loading"])])])]})),default:d((()=>[_((o(),p(M,{gutter:20},{default:d((()=>[r(m,{span:8},{default:d((()=>{var a,s,e,u,n,v,c;return[i("div",aa,[i("div",la,[r(t,{size:"24",color:!0===(null==(a=ha.value)?void 0:a.isRunning)?"#67C23A":!1===(null==(s=ha.value)?void 0:s.isRunning)?"#F56C6C":"#E6A23C"},{default:d((()=>[r(f(S))])),_:1},8,["color"])]),l[21]||(l[21]=i("div",{class:"stat-title"},"服务状态",-1)),i("div",{class:h(["stat-value",{success:!0===(null==(e=ha.value)?void 0:e.isRunning),danger:!1===(null==(u=ha.value)?void 0:u.isRunning),warning:null===(null==(n=ha.value)?void 0:n.isRunning)}])},y(!0===(null==(v=ha.value)?void 0:v.isRunning)?"运行中":!1===(null==(c=ha.value)?void 0:c.isRunning)?"已停止":"状态未知"),3)])]})),_:1}),r(m,{span:8},{default:d((()=>{var a;return[i("div",sa,[i("div",ta,[r(t,{size:"24",color:"#409EFF"},{default:d((()=>[r(f(C))])),_:1})]),l[22]||(l[22]=i("div",{class:"stat-title"},"API端口",-1)),i("div",ea,y((null==(a=ha.value)?void 0:a.apiPort)||"18080"),1)])]})),_:1}),r(m,{span:8},{default:d((()=>{var a;return[i("div",ua,[i("div",na,[r(t,{size:"24",color:"#E6A23C"},{default:d((()=>[r(f(G))])),_:1})]),l[23]||(l[23]=i("div",{class:"stat-title"},"观察器端口",-1)),i("div",ia,y((null==(a=ma.value)?void 0:a.port)||"18081"),1)])]})),_:1})])),_:1})),[[ra,ca.value]])])),_:1})])}}},[["__scopeId","data-v-90ece43d"]]);export{ra as default};
