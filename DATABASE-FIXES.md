# 数据库修复说明

## 背景

原 GOST 管理系统项目从未使用数据库迁移系统，而是通过 `complete_schema.sql` 直接初始化数据库结构。为了修复现有数据库中的已知问题，我们创建了一个数据库修复系统。

## 修复系统

### 文件位置
- `backend/database-fixes.js` - 数据库修复脚本

### 运行方式
```bash
# 手动运行
cd backend
node database-fixes.js

# 自动运行（在 smart-update.sh 中）
./smart-update.sh
```

## 当前修复项目

### 1. 邮箱唯一性约束修复
- **问题**: 数据库中 email 字段有 UNIQUE 约束，导致无法创建多个邮箱为空的用户
- **解决**: 移除数据库表中的 email UNIQUE 约束，改为在应用层处理
- **状态**: 幂等操作，可安全重复运行

## 特性

- **幂等性**: 所有修复都可以安全地多次运行
- **智能检测**: 自动检查是否需要修复
- **详细日志**: 提供清晰的执行状态
- **错误处理**: 修复失败不会中断更新流程

## 集成

修复脚本已集成到 `smart-update.sh` 中，在步骤7自动运行：

```
🔧 步骤7: 检查数据库修复...
📋 发现数据库修复脚本，开始执行...
✅ 数据库修复完成
```

## 与迁移系统的区别

| 特性 | 传统迁移 | 数据库修复 |
|------|----------|------------|
| 目的 | 版本化数据库变更 | 修复现有问题 |
| 执行方式 | 按版本顺序执行 | 检测问题并修复 |
| 重复执行 | 通常不允许 | 完全幂等 |
| 状态跟踪 | 需要迁移表 | 实时检测 |
| 适用场景 | 新项目开发 | 现有项目修复 |

## 注意事项

1. 修复前会自动备份数据库（通过 smart-update.sh）
2. 所有修复都是幂等的，可以安全重复运行
3. 修复失败不会中断系统更新流程
4. 建议在测试环境先验证修复效果
