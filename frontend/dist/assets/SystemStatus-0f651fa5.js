var a=(a,l,s)=>new Promise(((t,e)=>{var u=a=>{try{i(s.next(a))}catch(l){e(l)}},n=a=>{try{i(s.throw(a))}catch(l){e(l)}},i=a=>a.done?t(a.value):Promise.resolve(a.value).then(u,n);i((s=s.apply(a,l)).next())}));import{_ as l,u as s,a as t,m as e,E as u,r as n,n as i,J as r,d,g as v,e as o,w as c,f,v as g,o as _,i as h,x as p,k as y,M as R,q as m,N as S,O as P,y as k,t as C,P as z,z as M,Q as w,R as G,S as T}from"./index-8b22735b.js";import{a as F}from"./api-2b28bc5e.js";const O={class:"system-status"},x={class:"page-header"},B={class:"header-actions"},b={class:"card-header"},A={class:"header-left"},E={class:"stat-card"},I={class:"stat-value"},$={class:"stat-card"},U={class:"stat-value"},j={class:"stat-card"},q={class:"stat-value"},D={class:"stat-card"},J={class:"stat-value"},K={class:"card-header"},N={class:"header-left"},Q={class:"service-card"},H={class:"service-title"},L={class:"service-card"},V={class:"service-title"},W={class:"service-card"},X={class:"service-title"},Y={class:"card-header"},Z={class:"header-left"},aa={class:"header-actions"},la={class:"stat-card gost-stat-card"},sa={class:"stat-icon"},ta={class:"stat-card gost-stat-card"},ea={class:"stat-icon"},ua={class:"stat-value"},na={class:"stat-card gost-stat-card"},ia={class:"stat-icon"},ra={class:"stat-value"},da=l({__name:"SystemStatus",setup(l){const da=s(),va=t();e((()=>da.getters["user/isAdmin"])).value||(u.error("此功能仅限管理员使用"),va.push("/dashboard"));const oa=n(!1),ca=n(!1),fa=n(!1),ga=n(null),_a=n(null),ha=n(null),pa=n(null),ya=n(null),Ra=n(null),ma=n(null);let Sa=null;const Pa=e((()=>{var a,l,s,t,e;if(!ga.value)return!1;const u=!0===(null==(a=Ra.value)?void 0:a.isRunning),n=!1!==(null==(l=ha.value)?void 0:l.isRunning),i=!1!==(null==(s=pa.value)?void 0:s.isRunning),r=!1!==(null==(t=ya.value)?void 0:t.isRunning),d=!1!==(null==(e=ma.value)?void 0:e.isRunning);return u&&n&&i&&r&&d})),ka=()=>a(this,null,(function*(){var a,l;try{oa.value=!0;const[t,e,u]=yield Promise.allSettled([F.system.getStatus(),da.dispatch("traffic/fetchStats"),F.system.getGostStatus()]);if("fulfilled"===t.status&&(ga.value=t.value.data.data),"fulfilled"===e.status?_a.value={users:{total:e.value.totalUsers||0,active:e.value.activeUsers||0},rules:{total:e.value.activeRules||0},traffic:{total:e.value.totalTraffic||0}}:_a.value={users:{total:0,active:0},rules:{total:0},traffic:{total:0}},"fulfilled"===u.status)Ra.value=u.value.data.data;else{if(401===(null==(l=null==(a=u.reason)?void 0:a.response)?void 0:l.status))try{const a=yield F.gost.getStatus();Ra.value={isRunning:a.data.data.isRunning,apiPort:"18080",healthyPorts:[],fallbackMode:!0}}catch(s){Ra.value||(Ra.value={isRunning:null,apiPort:"18080",healthyPorts:[],error:"无法获取状态"})}else Ra.value||(Ra.value={isRunning:null,apiPort:"18080",healthyPorts:[],error:"网络错误或服务不可用"})}ha.value={isRunning:!0,stats:{checksPerformed:0,violationsFound:0}},pa.value={isRunning:!0,stats:{activeUsers:0,quotaChecks:0}},ya.value={isRunning:!0,stats:{lastSync:(new Date).toISOString(),syncCount:0}},ma.value={isRunning:!0,port:18081}}catch(t){u.error("获取系统状态失败: "+(t.message||"未知错误"))}finally{oa.value=!1}})),Ca=()=>a(this,null,(function*(){var a;try{ca.value=!0;const a=yield F.system.getGostStatus();Ra.value=a.data.data}catch(l){if(401===(null==(a=null==l?void 0:l.response)?void 0:a.status))try{const a=yield F.gost.getStatus();Ra.value={isRunning:a.data.data.isRunning,apiPort:"18080",healthyPorts:[],fallbackMode:!0},u.success("已使用备用方式获取GOST状态")}catch(s){u.error("无法获取GOST状态，请检查服务状态"),Ra.value||(Ra.value={isRunning:null,apiPort:"18080",healthyPorts:[],error:"无法获取状态"})}else u.error("获取GOST状态失败: "+(l.message||"未知错误")),Ra.value||(Ra.value={isRunning:null,apiPort:"18080",healthyPorts:[],error:"网络错误或服务不可用"})}finally{ca.value=!1}})),za=()=>a(this,null,(function*(){try{fa.value=!0,yield F.system.forceSync(),u.success("强制同步已触发"),setTimeout(ka,2e3)}catch(a){u.error("强制同步失败")}finally{fa.value=!1}})),Ma=()=>a(this,null,(function*(){try{ca.value=!0,yield F.system.restartGost(),u.success("GOST服务重启成功"),setTimeout(Ca,3e3)}catch(a){u.error("重启GOST失败")}finally{ca.value=!1}})),wa=a=>{if(!a)return"未知";const l=Math.floor(a/86400),s=Math.floor(a%86400/3600);let t="";return l>0&&(t+=`${l}天 `),(s>0||l>0)&&(t+=`${s}小时 `),t+=`${Math.floor(a%3600/60)}分钟`,t},Ga=a=>{if(!a||0===a)return"0 B";const l=Math.floor(Math.log(a)/Math.log(1024));return parseFloat((a/Math.pow(1024,l)).toFixed(2))+" "+["B","KB","MB","GB","TB"][l]};return i((()=>{ka(),Sa=setInterval(ka,3e4)})),r((()=>{Sa&&clearInterval(Sa)})),(a,l)=>{const s=f("el-page-header"),t=f("el-icon"),e=f("el-button"),u=f("el-tag"),n=f("el-col"),i=f("el-row"),r=f("el-card"),F=g("loading");return _(),d("div",O,[v("div",x,[o(s,{onBack:l[0]||(l[0]=l=>a.$router.go(-1)),content:"系统状态监控"}),v("div",B,[o(e,{type:"primary",onClick:ka,loading:oa.value},{default:c((()=>[o(t,null,{default:c((()=>[o(h(p))])),_:1}),l[1]||(l[1]=y(" 刷新状态 "))])),_:1,__:[1]},8,["loading"])])]),o(r,{class:"status-card overview-card"},{header:c((()=>[v("div",b,[v("div",A,[o(t,{size:"20",color:"#409EFF"},{default:c((()=>[o(h(R))])),_:1}),l[2]||(l[2]=v("span",null,"系统概览",-1))]),Pa.value?(_(),m(u,{key:0,type:"success",size:"large"},{default:c((()=>[o(t,null,{default:c((()=>[o(h(S))])),_:1}),l[3]||(l[3]=y(" 系统正常 "))])),_:1,__:[3]})):(_(),m(u,{key:1,type:"danger",size:"large"},{default:c((()=>[o(t,null,{default:c((()=>[o(h(P))])),_:1}),l[4]||(l[4]=y(" 系统异常 "))])),_:1,__:[4]}))])])),default:c((()=>[k((_(),m(i,{gutter:20},{default:c((()=>[o(n,{span:6},{default:c((()=>{var a;return[v("div",E,[l[5]||(l[5]=v("div",{class:"stat-title"},"系统运行时间",-1)),v("div",I,C(wa(null==(a=ga.value)?void 0:a.uptime)),1)])]})),_:1}),o(n,{span:6},{default:c((()=>{var a,s;return[v("div",$,[l[6]||(l[6]=v("div",{class:"stat-title"},"总用户数",-1)),v("div",U,C((null==(s=null==(a=_a.value)?void 0:a.users)?void 0:s.total)||0),1)])]})),_:1}),o(n,{span:6},{default:c((()=>{var a,s;return[v("div",j,[l[7]||(l[7]=v("div",{class:"stat-title"},"活跃规则",-1)),v("div",q,C((null==(s=null==(a=_a.value)?void 0:a.rules)?void 0:s.total)||0),1)])]})),_:1}),o(n,{span:6},{default:c((()=>{var a,s;return[v("div",D,[l[8]||(l[8]=v("div",{class:"stat-title"},"总流量",-1)),v("div",J,C(Ga(null==(s=null==(a=_a.value)?void 0:a.traffic)?void 0:s.total)),1)])]})),_:1})])),_:1})),[[F,oa.value]])])),_:1}),o(r,{class:"status-card services-card"},{header:c((()=>[v("div",K,[v("div",N,[o(t,{size:"20",color:"#67C23A"},{default:c((()=>[o(h(z))])),_:1}),l[9]||(l[9]=v("span",null,"服务状态",-1))]),o(e,{type:"primary",size:"small",onClick:za,loading:fa.value},{default:c((()=>[o(t,null,{default:c((()=>[o(h(p))])),_:1}),l[10]||(l[10]=y(" 强制同步 "))])),_:1,__:[10]},8,["loading"])])])),default:c((()=>[k((_(),m(i,{gutter:20},{default:c((()=>[o(n,{span:8},{default:c((()=>{var a,s;return[v("div",Q,[v("div",H,[o(t,null,{default:c((()=>[o(h(R))])),_:1}),l[11]||(l[11]=y(" 实时监控 "))]),v("div",{class:M(["service-status",{running:null==(a=ha.value)?void 0:a.isRunning}])},C((null==(s=ha.value)?void 0:s.isRunning)?"运行中":"已停止"),3),l[12]||(l[12]=v("div",{class:"service-details"},[v("p",null,"流量监控服务")],-1))])]})),_:1}),o(n,{span:8},{default:c((()=>[v("div",L,[v("div",V,[o(t,null,{default:c((()=>[o(h(z))])),_:1}),l[13]||(l[13]=y(" 配额协调器 "))]),l[14]||(l[14]=v("div",{class:"service-status running"}," 运行中 ",-1)),l[15]||(l[15]=v("div",{class:"service-details"},[v("p",null,"用户配额管理")],-1))])])),_:1}),o(n,{span:8},{default:c((()=>{var a,s;return[v("div",W,[v("div",X,[o(t,null,{default:c((()=>[o(h(w))])),_:1}),l[16]||(l[16]=y(" 同步协调器 "))]),v("div",{class:M(["service-status",{running:!(null==(a=ya.value)?void 0:a.isSyncing)}])},C((null==(s=ya.value)?void 0:s.isSyncing)?"同步中":"空闲"),3),l[17]||(l[17]=v("div",{class:"service-details"},[v("p",null,"配置同步服务")],-1))])]})),_:1})])),_:1})),[[F,oa.value]])])),_:1}),o(r,{class:"status-card gost-card"},{header:c((()=>{var a,s;return[v("div",Y,[v("div",Z,[l[18]||(l[18]=v("span",null,"GOST服务状态",-1)),o(u,{type:!0===(null==(a=Ra.value)?void 0:a.isRunning)?"success":!1===(null==(s=Ra.value)?void 0:s.isRunning)?"danger":"warning",size:"small",style:{"margin-left":"12px"}},{default:c((()=>{var a,l;return[y(C(!0===(null==(a=Ra.value)?void 0:a.isRunning)?"运行中":!1===(null==(l=Ra.value)?void 0:l.isRunning)?"已停止":"状态未知"),1)]})),_:1},8,["type"])]),v("div",aa,[o(e,{link:"",onClick:Ca,loading:ca.value},{default:c((()=>[o(t,null,{default:c((()=>[o(h(p))])),_:1}),l[19]||(l[19]=y(" 刷新 "))])),_:1,__:[19]},8,["loading"]),o(e,{type:"warning",size:"small",onClick:Ma,loading:ca.value},{default:c((()=>[o(t,null,{default:c((()=>[o(h(G))])),_:1}),l[20]||(l[20]=y(" 重启服务 "))])),_:1,__:[20]},8,["loading"])])])]})),default:c((()=>[k((_(),m(i,{gutter:20},{default:c((()=>[o(n,{span:8},{default:c((()=>{var a,s,e,u,n,i,r;return[v("div",la,[v("div",sa,[o(t,{size:"24",color:!0===(null==(a=Ra.value)?void 0:a.isRunning)?"#67C23A":!1===(null==(s=Ra.value)?void 0:s.isRunning)?"#F56C6C":"#E6A23C"},{default:c((()=>[o(h(R))])),_:1},8,["color"])]),l[21]||(l[21]=v("div",{class:"stat-title"},"服务状态",-1)),v("div",{class:M(["stat-value",{success:!0===(null==(e=Ra.value)?void 0:e.isRunning),danger:!1===(null==(u=Ra.value)?void 0:u.isRunning),warning:null===(null==(n=Ra.value)?void 0:n.isRunning)}])},C(!0===(null==(i=Ra.value)?void 0:i.isRunning)?"运行中":!1===(null==(r=Ra.value)?void 0:r.isRunning)?"已停止":"状态未知"),3)])]})),_:1}),o(n,{span:8},{default:c((()=>{var a;return[v("div",ta,[v("div",ea,[o(t,{size:"24",color:"#409EFF"},{default:c((()=>[o(h(w))])),_:1})]),l[22]||(l[22]=v("div",{class:"stat-title"},"API端口",-1)),v("div",ua,C((null==(a=Ra.value)?void 0:a.apiPort)||"18080"),1)])]})),_:1}),o(n,{span:8},{default:c((()=>{var a;return[v("div",na,[v("div",ia,[o(t,{size:"24",color:"#E6A23C"},{default:c((()=>[o(h(T))])),_:1})]),l[23]||(l[23]=v("div",{class:"stat-title"},"观察器端口",-1)),v("div",ra,C((null==(a=ma.value)?void 0:a.port)||"18081"),1)])]})),_:1})])),_:1})),[[F,ca.value]])])),_:1})])}}},[["__scopeId","data-v-a18b8ddb"]]);export{da as default};
