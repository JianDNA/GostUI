var a=(a,s,e)=>new Promise(((n,t)=>{var l=a=>{try{c(e.next(a))}catch(s){t(s)}},o=a=>{try{c(e.throw(a))}catch(s){t(s)}},c=a=>a.done?n(a.value):Promise.resolve(a.value).then(l,o);c((e=e.apply(a,s)).next())}));import{_ as s,u as e,a as n,m as t,E as l,r as o,c,n as i,J as d,K as r,L as u,d as g,g as y,e as v,w as p,q as f,s as m,f as h,o as b,k as _,t as C,z as S,F as k,D as w}from"./index-8b22735b.js";import{a as E}from"./api-2b28bc5e.js";const L={class:"gost-config"},x={class:"page-header"},A={class:"header-actions"},j={class:"stat-content"},T={class:"stat-number"},V={class:"stat-content"},P={class:"stat-number"},z={class:"stat-content"},D={class:"stat-number"},F={class:"stat-content"},I={class:"card-header"},J={class:"comparison-info"},M={style:{"margin-top":"8px"}},O={class:"config-content"},R={class:"config-header"},q={class:"config-json"},G={class:"config-content"},H={class:"config-header"},N={class:"config-json"},K={class:"card-header"},U={class:"log-content"},B={key:0,class:"no-logs"},Q={key:1},W={class:"log-time"},X={class:"log-message"};const Y=s({name:"GostConfig",setup(){const s=e(),g=n();if(!t((()=>s.getters["user/isAdmin"])).value)return l.error("此功能仅限管理员使用"),g.push("/dashboard"),{};const y=o(!1),v=c({serviceCount:0,portCount:0,userCount:0,protocols:[]}),p=o(!1),f=o(null),m=o("generated"),h=o([]),b=o(null),_=(a,s="info")=>{h.value.unshift({time:new Date,message:a,type:s}),h.value.length>50&&(h.value=h.value.slice(0,50))},C=()=>a(this,null,(function*(){var a,s;try{const a=yield E.get("/gost-config/stats");Object.assign(v,a.data.data);try{const a=yield E.get("/gost-config/sync-status");p.value=a.data.data.autoSyncRunning||!1}catch(e){}}catch(e){_("加载统计信息失败: "+((null==(s=null==(a=e.response)?void 0:a.data)?void 0:s.message)||e.message),"error")}})),S=()=>a(this,null,(function*(){var a,s,e;try{const a=yield E.get("/gost-config/compare");f.value=a.data.data}catch(n){401===(null==(a=n.response)?void 0:a.status)?(f.value={isChanged:!1,reason:"auth_required",message:"需要管理员权限查看配置比较"},_("配置比较需要管理员权限","warning")):(f.value={isChanged:!1,reason:"comparison_failed",message:"配置比较服务暂时不可用"},l.error("加载配置对比失败"),_("配置比较加载失败: "+((null==(e=null==(s=n.response)?void 0:s.data)?void 0:e.message)||n.message),"error"))}})),k=(s=!1)=>a(this,null,(function*(){var a,e,n,t;y.value=!0;try{const a=yield E.post("/gost-config/sync",{force:s}),e=a.data.data;e.updated?(l.success("配置已更新并同步"),_("手动同步成功，配置已更新","success")):e.skipped?(l.warning(a.data.message||"同步已跳过"),_(a.data.message||"同步已跳过","warning")):(l.info("配置无变化"),_("手动同步完成，配置无变化","info")),yield C(),yield S()}catch(o){l.error("手动同步失败: "+((null==(e=null==(a=o.response)?void 0:a.data)?void 0:e.message)||o.message)),_("手动同步失败: "+((null==(t=null==(n=o.response)?void 0:n.data)?void 0:t.message)||o.message),"error")}finally{y.value=!1}})),w=()=>a(this,null,(function*(){try{yield E.post("/gost-config/auto-sync/start"),l.success("自动同步已启动"),_("自动同步已启动","success"),p.value=!0,yield C()}catch(a){l.error("启动自动同步失败"),_("启动自动同步失败","error")}})),L=()=>a(this,null,(function*(){try{yield E.post("/gost-config/auto-sync/stop"),l.success("自动同步已停止"),_("自动同步已停止","warning"),p.value=!1,yield C()}catch(a){l.error("停止自动同步失败"),_("停止自动同步失败","error")}})),x=()=>{b.value=setInterval((()=>a(this,null,(function*(){yield C(),f.value&&(yield S())}))),3e4)};return i((()=>a(this,null,(function*(){_("页面已加载"),yield C(),yield S(),x()})))),d((()=>{b.value&&(clearInterval(b.value),b.value=null)})),{syncing:y,stats:v,comparison:f,activeTab:m,syncLogs:h,addLog:_,formatTime:a=>a.toLocaleString(),clearLogs:()=>{h.value=[],_("日志已清空")},loadStats:C,loadComparison:S,syncConfig:k,handleManualSync:k,handleForceSync:()=>a(this,null,(function*(){yield k(!0)})),handleStartAutoSync:w,handleStopAutoSync:L,toggleAutoSync:()=>a(this,null,(function*(){p.value?yield L():yield w()})),autoSyncEnabled:p,Check:r,Close:u}}},[["render",function(a,s,e,n,t,l){const o=h("el-button"),c=h("el-card"),i=h("el-col"),d=h("el-row"),r=h("el-alert"),u=h("el-tab-pane"),E=h("el-tabs");return b(),g("div",L,[y("div",x,[s[3]||(s[3]=y("h2",null,"Gost 配置管理",-1)),y("div",A,[v(o,{type:"primary",onClick:n.handleManualSync,loading:n.syncing,icon:"Refresh"},{default:p((()=>s[2]||(s[2]=[_(" 手动同步 ")]))),_:1,__:[2]},8,["onClick","loading"]),v(o,{type:n.autoSyncEnabled?"warning":"success",onClick:n.toggleAutoSync,loading:n.syncing,icon:n.autoSyncEnabled?"VideoPause":"VideoPlay"},{default:p((()=>[_(C(n.autoSyncEnabled?"停止自动同步":"启动自动同步"),1)])),_:1},8,["type","onClick","loading","icon"])])]),v(d,{gutter:20,class:"stats-row"},{default:p((()=>[v(i,{span:6},{default:p((()=>[v(c,{class:"stat-card"},{default:p((()=>[y("div",j,[y("div",T,C(n.stats.serviceCount||0),1),s[4]||(s[4]=y("div",{class:"stat-label"},"服务数量",-1)),s[5]||(s[5]=y("div",{class:"stat-description"},"当前运行的服务",-1))])])),_:1})])),_:1}),v(i,{span:6},{default:p((()=>[v(c,{class:"stat-card"},{default:p((()=>[y("div",V,[y("div",P,C(n.stats.portCount||0),1),s[6]||(s[6]=y("div",{class:"stat-label"},"端口数量",-1)),s[7]||(s[7]=y("div",{class:"stat-description"},"已配置的端口",-1))])])),_:1})])),_:1}),v(i,{span:6},{default:p((()=>[v(c,{class:"stat-card"},{default:p((()=>[y("div",z,[y("div",D,C(n.stats.userCount||0),1),s[8]||(s[8]=y("div",{class:"stat-label"},"用户数量",-1)),s[9]||(s[9]=y("div",{class:"stat-description"},"系统用户总数",-1))])])),_:1})])),_:1}),v(i,{span:6},{default:p((()=>[v(c,{class:"stat-card clickable-card",onClick:n.toggleAutoSync},{default:p((()=>[y("div",F,[y("div",{class:S(["stat-number",{enabled:n.autoSyncEnabled,disabled:!n.autoSyncEnabled}])},C(n.autoSyncEnabled?"开启":"停止"),3),s[10]||(s[10]=y("div",{class:"stat-label"},"自动同步",-1)),y("div",{class:S(["stat-description",{enabled:n.autoSyncEnabled,disabled:!n.autoSyncEnabled}])},C(n.autoSyncEnabled?"配置自动同步中":"点击启用自动同步"),3)])])),_:1},8,["onClick"])])),_:1})])),_:1}),n.comparison?(b(),f(c,{key:0,class:"config-compare"},{header:p((()=>[y("div",I,[s[12]||(s[12]=y("span",null,"配置对比",-1)),v(o,{type:"text",onClick:n.loadComparison,icon:"Refresh"},{default:p((()=>s[11]||(s[11]=[_("刷新")]))),_:1,__:[11]},8,["onClick"])])])),default:p((()=>[y("div",J,[n.comparison.isChanged?(b(),f(r,{key:0,title:"配置已变更",type:"warning","show-icon":"",closable:!1},{default:p((()=>[s[15]||(s[15]=y("div",null,"检测到配置变化，建议手动同步或等待自动同步",-1)),y("div",M,[v(o,{type:"primary",size:"small",onClick:s[0]||(s[0]=a=>n.handleManualSync(!1)),loading:n.syncing},{default:p((()=>s[13]||(s[13]=[_(" 立即同步 ")]))),_:1,__:[13]},8,["loading"]),v(o,{type:"warning",size:"small",onClick:n.handleForceSync,loading:n.syncing},{default:p((()=>s[14]||(s[14]=[_(" 强制同步 ")]))),_:1,__:[14]},8,["onClick","loading"])])])),_:1})):(b(),f(r,{key:1,title:"配置已同步",type:"success",description:"当前配置与生成配置一致","show-icon":"",closable:!1}))]),v(E,{modelValue:n.activeTab,"onUpdate:modelValue":s[1]||(s[1]=a=>n.activeTab=a),class:"config-tabs"},{default:p((()=>[v(u,{label:"生成的配置",name:"generated"},{default:p((()=>[y("div",O,[y("div",R,[y("span",null,"服务数量: "+C(n.comparison.generated.services.length),1),y("span",null,"哈希值: "+C(n.comparison.generatedHash.substring(0,16))+"...",1)]),y("pre",q,C(JSON.stringify(n.comparison.generated,null,2)),1)])])),_:1}),v(u,{label:"当前配置",name:"current"},{default:p((()=>[y("div",G,[y("div",H,[y("span",null,"服务数量: "+C(n.comparison.current.services.length),1),y("span",null,"哈希值: "+C(n.comparison.currentHash.substring(0,16))+"...",1)]),y("pre",N,C(JSON.stringify(n.comparison.current,null,2)),1)])])),_:1})])),_:1},8,["modelValue"])])),_:1})):m("",!0),v(c,{class:"sync-log"},{header:p((()=>[y("div",K,[s[17]||(s[17]=y("span",null,"同步日志",-1)),v(o,{type:"text",onClick:n.clearLogs,icon:"Delete"},{default:p((()=>s[16]||(s[16]=[_("清空日志")]))),_:1,__:[16]},8,["onClick"])])])),default:p((()=>[y("div",U,[0===n.syncLogs.length?(b(),g("div",B," 暂无同步日志 ")):(b(),g("div",Q,[(b(!0),g(k,null,w(n.syncLogs,((a,s)=>(b(),g("div",{key:s,class:S(["log-item",a.type])},[y("div",W,C(n.formatTime(a.time)),1),y("div",X,C(a.message),1)],2)))),128))]))])])),_:1})])}],["__scopeId","data-v-d023b86c"]]);export{Y as default};
