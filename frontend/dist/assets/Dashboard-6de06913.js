import{ax as a,r as t,c as e,k as s,n as l,z as r,P as o,H as c,G as u,K as i,ag as d,aq as n,y as v,A as f,u as p,L as h,I as y,C as g,M as m}from"./vue-9e38bd25.js";import{E as _,r as w,e as b}from"./element-plus-a98c71bf.js";import{i as x}from"./charts-37cc03ee.js";import{_ as k}from"./index-1003864c.js";import"./utils-c29d00eb.js";const S={class:"dashboard"},M={class:"card-header"},D={class:"stat-card"},G={class:"stat-card"},$={class:"stat-value"},z={class:"stat-card"},A={class:"stat-value"},L={class:"card-header"},P={class:"card-header"},j={class:"stat-card"},B={class:"stat-value"},C={class:"stat-card"},F={class:"stat-value"},E={class:"stat-card"},I={class:"stat-value"},T=k({__name:"Dashboard",setup(k){const T=a(),H=t(!1),O=t(null),K=t("today"),N=t(!1),R=t(null),q=t(null);let U=null;const J=e((()=>T.getters["gost/isRunning"])),Q=e((()=>T.getters["gost/portForwards"])),V=e((()=>T.getters["gost/systemInfo"])),W=e((()=>T.getters["user/isAdmin"])),X=async()=>{try{H.value=!0,O.value=await T.dispatch("traffic/fetchStats")}catch(a){_.error(a.message||"获取统计数据失败")}finally{H.value=!1}},Y=async()=>{try{N.value=!0,R.value=await T.dispatch("gost/fetchStatus")}catch(a){_.error(a.message||"获取Gost服务状态失败")}finally{N.value=!1}},Z=async()=>{try{await T.dispatch("gost/startService"),_.success("Gost服务启动成功")}catch(a){_.error(a.message||"启动Gost服务失败")}},aa=async()=>{try{await T.dispatch("gost/stopService"),_.success("Gost服务已停止")}catch(a){_.error(a.message||"停止Gost服务失败")}},ta=async()=>{try{await T.dispatch("gost/restartService"),_.success("Gost服务已重启")}catch(a){_.error(a.message||"重启Gost服务失败")}},ea=a=>{if(0===a)return"0 B";const t=Math.floor(Math.log(a)/Math.log(1024));return parseFloat((a/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB","TB"][t]},sa=a=>{if(!a)return"未知";const t=Math.floor(a/86400),e=Math.floor(a%86400/3600);let s="";return t>0&&(s+=`${t}天 `),(e>0||t>0)&&(s+=`${e}小时 `),s+=`${Math.floor(a%3600/60)}分钟`,s};return s((async()=>{X(),Y(),await l(),(()=>{if(q.value&&!U){U=x(q.value);const a={title:{text:"流量趋势",left:"center",textStyle:{fontSize:16,color:"#333"}},tooltip:{trigger:"axis",formatter:function(a){const t=a[0];return`${t.name}<br/>${t.seriesName}: ${ea(t.value)}`}},xAxis:{type:"category",data:[],axisLabel:{color:"#666"}},yAxis:{type:"value",axisLabel:{color:"#666",formatter:function(a){return ea(a)}}},series:[{name:"流量",type:"line",data:[],smooth:!0,lineStyle:{color:"#409EFF"},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(64, 158, 255, 0.3)"},{offset:1,color:"rgba(64, 158, 255, 0.1)"}]}}}]};U.setOption(a),window.addEventListener("resize",(()=>{U&&U.resize()}))}})(),(async()=>{try{const a=await fetch("/api/dashboard/traffic-trend?days="+("today"===K.value?1:"week"===K.value?7:30)),t=await a.json();if(U){const a=[],e=[];if(t.success&&t.data&&0!==t.data.length)t.data.forEach((t=>{const s=new Date(t.date);a.push(s.toLocaleDateString()),e.push(t.traffic)}));else{const t=new Date;for(let s=("today"===K.value?1:"week"===K.value?7:30)-1;s>=0;s--){const l=new Date(t.getTime()-24*s*60*60*1e3);a.push(l.toLocaleDateString()),e.push(1024*(150*Math.random()+50)*1024)}}U.setOption({xAxis:{data:a},series:[{data:e}]})}}catch(a){if(U){const a=[],t=[],e=new Date;for(let s=6;s>=0;s--){const l=new Date(e.getTime()-24*s*60*60*1e3);a.push(l.toLocaleDateString()),t.push(1024*(150*Math.random()+50)*1024)}U.setOption({xAxis:{data:a},series:[{data:t}]})}}})()})),(a,t)=>{var e;const s=d("el-icon"),l=d("el-button"),_=d("el-col"),x=d("el-row"),k=d("el-card"),T=d("el-tag"),K=d("el-table-column"),q=d("el-table");d("el-option"),d("el-select");const U=n("loading");return v(),r("div",S,[o(k,{class:"dashboard-card"},{header:c((()=>[f("div",M,[t[4]||(t[4]=f("span",null,"Gost服务状态",-1)),f("div",null,[o(l,{link:"",onClick:Y},{default:c((()=>[o(s,null,{default:c((()=>[o(p(w))])),_:1})])),_:1}),!J.value&&W.value?(v(),u(l,{key:0,type:"success",size:"small",onClick:Z},{default:c((()=>t[1]||(t[1]=[h(" 启动服务 ")]))),_:1,__:[1]})):i("",!0),J.value&&W.value?(v(),u(l,{key:1,type:"danger",size:"small",onClick:aa},{default:c((()=>t[2]||(t[2]=[h(" 停止服务 ")]))),_:1,__:[2]})):i("",!0),W.value?(v(),u(l,{key:2,type:"primary",size:"small",onClick:ta},{default:c((()=>t[3]||(t[3]=[h(" 重启服务 ")]))),_:1,__:[3]})):i("",!0)])])])),default:c((()=>[y((v(),u(x,{gutter:20},{default:c((()=>[o(_,{span:8},{default:c((()=>[f("div",D,[t[5]||(t[5]=f("div",{class:"stat-title"},"服务状态",-1)),f("div",{class:g(["stat-value",{success:J.value,danger:!J.value}])},m(J.value?"运行中":"已停止"),3)])])),_:1}),J.value?(v(),u(_,{key:0,span:8},{default:c((()=>{var a;return[f("div",G,[t[6]||(t[6]=f("div",{class:"stat-title"},"进程ID",-1)),f("div",$,m(W.value?(null==(a=R.value)?void 0:a.pid)||"N/A":"****"),1)])]})),_:1})):i("",!0),J.value&&V.value?(v(),u(_,{key:1,span:8},{default:c((()=>[f("div",z,[t[7]||(t[7]=f("div",{class:"stat-title"},"运行时间",-1)),f("div",A,m(W.value?sa(V.value.uptime):"****"),1)])])),_:1})):i("",!0)])),_:1})),[[U,N.value]])])),_:1}),(null==(e=Q.value)?void 0:e.length)>0?(v(),u(k,{key:0,class:"dashboard-card"},{header:c((()=>[f("div",L,[t[8]||(t[8]=f("span",null,"端口转发详情",-1)),o(T,{effect:"dark",size:"small",type:"success"},{default:c((()=>[h(m(Q.value.length)+" 个活跃规则",1)])),_:1})])])),default:c((()=>[y((v(),u(q,{data:Q.value,stripe:"",style:{width:"100%"}},{default:c((()=>[o(K,{label:"名称"},{default:c((a=>[h(m(W.value?a.row.name:"****"),1)])),_:1}),o(K,{prop:"protocol",label:"协议"}),o(K,{label:"转发规则"},{default:c((a=>[o(T,{type:"primary"},{default:c((()=>[h(m(a.row.sourcePort||a.row.localPort)+" ",1),o(s,null,{default:c((()=>[o(p(b))])),_:1}),h(" "+m(W.value?`${a.row.targetHost}:${a.row.targetPort}`:"****:****"),1)])),_:2},1024)])),_:1}),o(K,{label:"源端口",width:"80"},{default:c((a=>[h(m(a.row.sourcePort||a.row.localPort),1)])),_:1}),o(K,{label:"目标地址",width:"150"},{default:c((a=>[h(m(W.value?`${a.row.targetHost}:${a.row.targetPort}`:"****:****"),1)])),_:1})])),_:1},8,["data"])),[[U,N.value]])])),_:1})):i("",!0),o(k,{class:"dashboard-card"},{header:c((()=>[f("div",P,[t[9]||(t[9]=f("span",null,"系统概览",-1)),o(l,{link:"",onClick:X},{default:c((()=>[o(s,null,{default:c((()=>[o(p(w))])),_:1})])),_:1})])])),default:c((()=>[y((v(),u(x,{gutter:20},{default:c((()=>[o(_,{span:8},{default:c((()=>{var a;return[f("div",j,[t[10]||(t[10]=f("div",{class:"stat-title"},"活跃用户",-1)),f("div",B,m(W.value?(null==(a=O.value)?void 0:a.activeUsers)||0:"****"),1)])]})),_:1}),o(_,{span:8},{default:c((()=>{var a;return[f("div",C,[t[11]||(t[11]=f("div",{class:"stat-title"},"活跃规则",-1)),f("div",F,m((null==(a=O.value)?void 0:a.activeRules)||0),1)])]})),_:1}),o(_,{span:8},{default:c((()=>{var a;return[f("div",E,[t[12]||(t[12]=f("div",{class:"stat-title"},"总流量",-1)),f("div",I,m(W.value?ea((null==(a=O.value)?void 0:a.totalTraffic)||0):"****"),1)])]})),_:1})])),_:1})),[[U,H.value]])])),_:1}),i("",!0)])}}},[["__scopeId","data-v-27308f6b"]]);export{T as default};
